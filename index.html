<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>POS 2025 — Одноразовые штрихкоды и QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:0;}
.app{max-width:1200px;margin:20px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 8px 28px rgba(0,0,0,.06);}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
h1{font-size:18px;margin:0;}
.muted{color:#6b7280;font-size:13px;}
.top{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
input,button{font-size:14px;padding:6px;border-radius:6px;border:1px solid #d1d5db;}
button.btn{padding:8px 12px;border:0;background:#2563eb;color:#fff;cursor:pointer;}
button.secondary{background:#6b7280;color:#fff;}
.layout{display:flex;gap:16px;}
.left{flex:2;}
.right{flex:1;}
.box{background:#fbfdff;padding:12px;border-radius:8px;border:1px solid #e6eef9;margin-bottom:12px;}
table{width:100%;border-collapse:collapse;}
td,th{padding:8px;border-bottom:1px dashed #e6eef9;text-align:left;}
.receipt{white-space:pre-wrap;background:#fff;padding:10px;border-radius:6px;border:1px solid #eee;min-height:120px;}
.barcode-area{background:#fff;padding:12px;border-radius:6px;border:1px solid #ddd;text-align:center;margin-top:6px;}
#barcode-svg{display:inline-block;padding:8px;background:#fff;}
.modal-back{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999;}
.modal{width:90%;max-width:1000px;background:#fff;border-radius:8px;padding:12px;max-height:90vh;overflow:auto;}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;}
.product-card{padding:8px;border:1px solid #e6eef9;border-radius:6px;background:#fbfdff;cursor:pointer;display:flex;flex-direction:column;gap:8px;}
.product-card:hover{box-shadow:0 6px 18px rgba(0,0,0,.06);}
.prod-title{font-weight:600;}
.prod-code{color:#6b7280;font-size:12px;}
.flex-row{display:flex;gap:8px;align-items:center;}
footer{margin-top:12px;color:#6b7280;font-size:13px;text-align:right;}
.qr-area{margin-top:12px;text-align:center;}
button.btn:hover{opacity:0.9;}
button.secondary:hover{opacity:0.85;}
input:focus{border-color:#2563eb;outline:none;}
.product-card:active{transform:scale(0.98);transition:0.1s;}
</style>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>POS 2025 — Одноразовые штрихкоды и QR</h1>
    <div class="muted">Firebase URL: <span id="db-url-display"></span></div>
  </div>
  <div style="text-align:right">
    <div class="muted">Кассир: <strong id="cashier-name">Демид Владимирович</strong></div>
    <div class="muted">ИНН: <strong id="company-inn">1234567890</strong></div>
  </div>
</header>
<div class="top">
  <input id="barcode-input" type="text" placeholder="Введите штрихкод / код товара и Enter" style="flex:1"/>
  <button id="btn-scan-sim" class="btn">Симулировать скан</button>
  <div style="margin-left:8px">
    <label class="muted">Firebase URL:</label><br/>
    <input id="firebase-url" type="text" style="width:360px" value="https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app"/>
  </div>
</div>
<div class="layout">
  <div class="left">
    <div class="box">
      <h3>Справочник товаров</h3>
      <div class="muted">Нажми F2 для генерации штрихкодов (пароль 0506)</div>
      <div id="products-preview" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px"></div>
    </div>
    <div class="box" id="cart-area">
      <h3>Корзина</h3>
      <div id="cart-list" class="muted">Корзина пуста</div>
      <div style="margin-top:8px" class="flex-row">
        <div class="muted">Итого:</div>
        <div id="cart-total" style="font-weight:700;margin-left:8px">0 ₽</div>
      </div>
    </div>
  </div>
<div class="right">
    <div class="box">
      <h3>Действия / Чек</h3>
      <div style="margin-top:8px">
        <button id="btn-finalize-cash" class="btn">Наличные</button>
        <button id="btn-pay-qr" class="btn secondary">Оплатить по QR</button>
        <button id="btn-clear-cart" class="btn secondary">Очистить корзину</button>
      </div>
      <div style="margin-top:12px" id="receipt-content" class="receipt">Чек появится здесь</div>
      <div id="qr-display" class="qr-area"></div>
    </div>
    <div class="box">
      <h3>Последний сгенерированный штрихкод</h3>
      <div id="last-barcode" class="barcode-area">Пока нет</div>
    </div>
  </div>
</div>
<footer>Пароль для страницы товаров (F2): <strong>0506</strong></footer>
</div>

<div id="modal-products" style="display:none">
  <div class="modal-back" id="modal-back">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2>Список товаров — клик для генерации штрихкода</h2>
        <button id="btn-close-modal" class="btn secondary">Закрыть</button>
      </div>
      <div id="product-grid" class="product-grid"></div>
      <div style="margin-top:12px" class="muted">Клик — генерирует новый уникальный штрихкод и загружает в Firebase.</div>
    </div>
  </div>
</div>

<script>
// ================== 200+ товары ==================
const PRODUCTS_DB=[];
for(let i=1;i<=200;i++){
  PRODUCTS_DB.push({
    code:(4000000000000+i).toString(),
    name:`Товар №${i}`,
    price:parseFloat((Math.random()*900+50).toFixed(2)),
    unit:'шт'
  });
}
const cart=[];

// ================== Корзина ==================
function renderCart(){
  const wrap=document.getElementById('cart-list');
  if(cart.length===0){wrap.innerHTML='<div class="muted">Корзина пуста</div>'; document.getElementById('cart-total').textContent='0 ₽'; return;}
  let html='<table style="width:100%"><thead><tr><th>Товар</th><th>Кол-во</th><th>Сумма</th></tr></thead><tbody>';
  let total=0;
  cart.forEach(it=>{
    const sum=it.qty*it.price;
    total+=sum;
    html+=`<tr><td>${it.name}</td><td>${it.qty}</td><td>${sum.toFixed(2)} ₽</td></tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;
  document.getElementById('cart-total').textContent=total.toFixed(2)+' ₽';
}
function addToCart(product){
  const found=cart.find(i=>i.code===product.code);
  if(found) found.qty++; else cart.push({...product,qty:1});
  renderCart();
}

// ================== Модалка товаров ==================
function renderProductsModal(){
  const grid=document.getElementById('product-grid');
  grid.innerHTML='';
  PRODUCTS_DB.forEach(prod=>{
    const div=document.createElement('div');
    div.className='product-card';
    div.innerHTML=`<div class="prod-title">${prod.name}</div><div class="prod-code">${prod.code}</div><div>${prod.price} ₽</div>`;
    div.onclick=async ()=>{
      const uniqueCode=prod.code+'-'+Date.now();
      document.getElementById('last-barcode').innerHTML='';
      const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
      JsBarcode(svg, uniqueCode,{format:"CODE128",width:2,height:40});
      document.getElementById('last-barcode').appendChild(svg);
      addToCart(prod);
      alert(`Сгенерирован одноразовый штрихкод: ${uniqueCode}`);
    };
    grid.appendChild(div);
  });
}
document.getElementById('btn-close-modal').onclick=()=>{document.getElementById('modal-products').style.display='none';};

// ================== F2 открытие модалки ==================
document.addEventListener('keydown',e=>{
  if(e.key==='F2'){
    const pwd=prompt('Введите пароль для списка товаров:');
    if(pwd==='0506'){ document.getElementById('modal-products').style.display='block'; renderProductsModal();}
    else alert('Неверный пароль!');
  }
});

// ================== Сканирование ==================
document.getElementById('barcode-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const code=e.target.value.trim();
    const prod=PRODUCTS_DB.find(p=>p.code===code);
if(prod) addToCart(prod);
    else alert('Товар не найден!');
    e.target.value='';
  }
});

// ================== Очистка корзины ==================
document.getElementById('btn-clear-cart').onclick=()=>{cart.length=0; renderCart(); document.getElementById('receipt-content').innerHTML='Чек появится здесь';};

// ================== Оплата наличными ==================
document.getElementById('btn-finalize-cash').onclick=()=>{
  if(cart.length===0){alert('Корзина пуста!'); return;}
  const total=cart.reduce((sum,it)=>sum+it.qty*it.price,0);
  const cash=parseFloat(prompt(`Итого ${total.toFixed(2)} ₽. Внесено:`));
  if(isNaN(cash)||cash<total){alert('Недостаточно денег!'); return;}
  const change=(cash-total).toFixed(2);
  let receipt='=== Чек ===\n';
  cart.forEach(it=>{receipt+=`${it.name} x${it.qty} = ${(it.qty*it.price).toFixed(2)} ₽\n`;});
  receipt+=`ИТОГО: ${total.toFixed(2)} ₽\nНаличные: ${cash.toFixed(2)} ₽\nСдача: ${change} ₽\nДата: ${new Date().toLocaleString()}`;
  document.getElementById('receipt-content').innerText=receipt;
  cart.length=0; renderCart();
};

// ================== Оплата QR ==================
document.getElementById('btn-pay-qr').onclick=()=>{
  if(cart.length===0){alert('Корзина пуста!'); return;}
  const total=cart.reduce((sum,it)=>sum+it.qty*it.price,0);
  const qrArea=document.getElementById('qr-display');
  qrArea.innerHTML='';
  const qrText=`https://renessans-bank.github.io/oplata/?sum=${total.toFixed(2)}`;
  QRCode.toCanvas(qrText,{width:150},(err,canvas)=>{
    if(err){alert(err); return;}
    qrArea.appendChild(canvas);
  });
  alert(`QR для оплаты на сумму ${total.toFixed(2)} ₽ сгенерирован!`);
};
</script>
</html>

