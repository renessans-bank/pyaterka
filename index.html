<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Касса «Пятёрка»</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background: #f5f5f5; }
    #login-screen, #cashier-screen, #product-catalog, #loyalty-form, #payment-screen, #receipt-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px;
    }
    #login-screen { display: flex; background: #2c3e50; color: white; justify-content: center; align-items: center; flex-direction: column; }
    #login-screen input { margin-top: 20px; padding: 12px; width: 300px; font-size: 18px; }
    .btn { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #3498db; color: white; border: none; }
    .btn-success { background: #2ecc71; color: white; border: none; }
    .btn-danger { background: #e74c3c; color: white; border: none; }
    .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; }
    .product-item { padding: 12px; border: 1px solid #ccc; margin: 5px; cursor: pointer; background: white; }
    .product-item:hover { background: #f0f8ff; }
    #barcode-display { text-align: center; margin: 20px 0; }
    #qrcode { text-align: center; margin: 20px 0; }
    #receipt-content { white-space: pre-wrap; font-family: monospace; background: white; padding: 20px; margin: 20px; }
  </style>
</head>
<body>

<!-- Экран входа -->
<div id="login-screen">
  <h2>Кассовая система «Пятёрка»</h2>
  <p>Введите пароль кассира:</p>
  <input type="password" id="password-input" placeholder="Пароль" maxlength="4" />
  <button class="btn btn-primary" onclick="login()">Войти</button>
</div>

<!-- Основной экран кассы -->
<div id="cashier-screen">
  <h2>Касса — Василькова О.Н.</h2>
  <div>
    <button class="btn btn-primary" onclick="showCatalog()">F2 — Каталог товаров</button>
    <button class="btn btn-success" onclick="openLoyalty()">Карта лояльности</button>
    <button class="btn btn-danger" onclick="resetSession()">Сброс</button>
  </div>

  <h3>Корзина</h3>
  <div id="cart-items"></div>
  <div><strong>Итого: <span id="total">0</span> ₽</strong></div>
  <div><strong>Бонусы: <span id="bonus-display">0</span> (можно списать)</strong></div>
  <button class="btn btn-success" onclick="openPayment()">Оплатить</button>
</div>

<!-- Каталог товаров -->
<div id="product-catalog">
  <h2>Каталог товаров (250+)</h2>
  <button class="btn btn-primary" onclick="closeCatalog()">← Назад</button>
  <div id="product-list" style="display: flex; flex-wrap: wrap;"></div>
</div>

<!-- Форма лояльности -->
<div id="loyalty-form" style="background: white; padding: 20px; display: none;">
  <h3>Карта лояльности</h3>
  <input type="tel" id="phone-input" placeholder="Телефон (79991234567)" maxlength="11" style="width: 100%; padding: 10px; margin: 10px 0;" />
  <div id="loyalty-actions"></div>
</div>

<!-- Экран оплаты -->
<div id="payment-screen" style="display: none; background: white; padding: 20px;">
  <h3>Оплата</h3>
  <p>Сумма: <span id="pay-amount">0</span> ₽</p>
  <p>Бонусы к списанию: <input type="number" id="use-bonus" min="0" value="0" style="width: 100px;" /> из <span id="max-bonus">0</span></p>
  <button class="btn btn-success" onclick="payCash()">Наличные</button>
  <button class="btn btn-primary" onclick="payCard()">Карта</button>
  <button class="btn btn-primary" onclick="payQR()">QR-оплата</button>
  <div id="qrcode"></div>
  <button class="btn btn-danger" onclick="closePayment()">Отмена</button>
</div>

<!-- Чек -->
<div id="receipt-screen" style="display: none;">
  <h2>Чек</h2>
  <pre id="receipt-content"></pre>
  <button class="btn btn-primary" onclick="printReceipt()">Печать</button>
  <button class="btn btn-success" onclick="backToCashier()">Новая покупка</button>
</div>

<script>
  // === Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === Глобальные переменные ===
  let cart = [];
  let loyaltyCard = null;
  let favoriteProduct = null;
  const CASHIER_PASSWORD = "0506";
  const BAG_BARCODE = "2000000000006"; // постоянный штрихкод для пакета

  // === Товары (250+) ===
  const baseProducts = [
    { name: "Молоко 1л", price: 89 },
    { name: "Хлеб белый", price: 45 },
    { name: "Яйца 10 шт", price: 85 },
    { name: "Сыр 200г", price: 199 },
    { name: "Колбаса докторская 300г", price: 249 },
    { name: "Помидоры 1кг", price: 159 },
    { name: "Огурцы 1кг", price: 139 },
    { name: "Картофель 1кг", price: 39 },
    { name: "Лук 1кг", price: 35 },
    { name: "Сахар 1кг", price: 75 },
    { name: "Мука 1кг", price: 65 },
    { name: "Макароны 400г", price: 59 },
    { name: "Рис 1кг", price: 119 },
    { name: "Чай черный 100п", price: 299 },
    { name: "Кофе молотый 200г", price: 399 },
    { name: "Сок яблочный 1л", price: 129 },
    { name: "Вода 1.5л", price: 49 },
    { name: "Пиво 0.5л", price: 89 },
    { name: "Водка 0.5л", price: 399 },
    { name: "Шампунь 400мл", price: 249 },
    { name: "Зубная паста", price: 129 },
    { name: "Туалетная бумага 12р", price: 199 },
    { name: "Стиральный порошок 3кг", price: 499 },
    { name: "Мыло хозяйственное", price: 45 },
    { name: "Батончики 3шт", price: 99 },
    { name: "Чипсы 150г", price: 89 },
    { name: "Шоколадка", price: 79 },
    { name: "Печенье 250г", price: 119 },
    { name: "Йогурт 150г", price: 49 },
    { name: "Творог 500г", price: 159 },
    { name: "Сметана 200г", price: 79 },
    { name: "Масло сливочное 200г", price: 189 },
    { name: "Майонез 400г", price: 129 },
    { name: "Кетчуп 300г", price: 99 },
    { name: "Гречка 1кг", price: 89 },
    { name: "Перец черный молотый", price: 69 },
    { name: "Соль 1кг", price: 25 },
    { name: "Уксус 9% 500мл", price: 45 },
    { name: "Газировка 2л", price: 99 },
    { name: "Энергетик 0.45л", price: 129 },
    { name: "Консервы рыбные", price: 159 },
    { name: "Консервы мясные", price: 179 },
    { name: "Круассан", price: 59 },
    { name: "Булочка с маком", price: 39 },
    { name: "Сырок глазированный", price: 29 },
    { name: "Мороженое 100г", price: 69 },
    { name: "Салат оливье 400г", price: 249 },
    { name: "Пельмени 1кг", price: 349 },
    { name: "Вареники 800г", price: 229 },
    { name: "Сосиски 400г", price: 199 },
    { name: "Курица охлажденная 1кг", price: 249 },
    { name: "Говядина 1кг", price: 699 },
    { name: "Свинина 1кг", price: 549 },
    { name: "Рыба мороженая 1кг", price: 399 },
    { name: "Креветки 300г", price: 599 },
    { name: "Икра заморская 100г", price: 299 },
    { name: "Масло подсолнечное 1л", price: 139 },
    { name: "Оливковое масло 500мл", price: 499 },
    { name: "Уксус бальзамический", price: 299 },
    { name: "Горчица 200г", price: 89 },
    { name: "Мед 500г", price: 399 },
    { name: "Варенье 400г", price: 199 },
    { name: "Кофе в зернах 250г", price: 599 },
    { name: "Какао порошок 200г", price: 149 },
    { name: "Молоко сгущенное", price: 129 },
    { name: "Печень овсяное", price: 89 },
    { name: "Сухарики 70г", price: 59 },
    { name: "Орехи 200г", price: 299 },
    { name: "Изюм 200г", price: 179 },
    { name: "Финики 200г", price: 249 },
    { name: "Бананы 1кг", price: 99 },
    { name: "Яблоки 1кг", price: 119 },
    { name: "Апельсины 1кг", price: 139 },
    { name: "Мандарины 1кг", price: 129 },
    { name: "Виноград 1кг", price: 249 },
    { name: "Киви 1кг", price: 299 },
    { name: "Ананас 1шт", price: 349 },
    { name: "Арбуз 1кг", price: 59 },
    { name: "Дыня 1кг", price: 89 },
    { name: "Персики 1кг", price: 199 },
    { name: "Сливы 1кг", price: 159 },
    { name: "Груши 1кг", price: 129 },
    { name: "Клубника 500г", price: 399 },
    { name: "Малина 500г", price: 499 },
    { name: "Черника 200г", price: 299 },
    { name: "Авокадо 1шт", price: 199 },
    { name: "Манго 1шт", price: 249 },
    { name: "Папайя 1шт", price: 299 },
    { name: "Гранат 1шт", price: 199 },
    { name: "Хурма 1кг", price: 179 },
    { name: "Инжир 300г", price: 299 },
    { name: "Кокос 1шт", price: 149 },
    { name: "Лайм 300г", price: 129 },
    { name: "Лимон 1кг", price: 119 },
    { name: "Имбирь 200г", price: 99 },
    { name: "Чеснок 200г", price: 69 },
    { name: "Петрушка пучок", price: 29 },
    { name: "Укроп пучок", price: 29 },
    { name: "Кинза пучок", price: 39 },
    { name: "Базилик пучок", price: 49 },
    { name: "Салат Айсберг", price: 79 },
    { name: "Шпинат 200г", price: 129 },
    { name: "Капуста белокочанная", price: 59 },
    { name: "Брокколи 500г", price: 199 },
    { name: "Цветная капуста", price: 149 },
    { name: "Морковь 1кг", price: 49 },
    { name: "Свекла 1кг", price: 45 },
    { name: "Редька 1кг", price: 59 },
    { name: "Репа 1кг", price: 49 },
    { name: "Тыква 1кг", price: 39 },
    { name: "Кабачок 1кг", price: 79 },
    { name: "Баклажан 1кг", price: 129 },
    { name: "Перец болгарский 1кг", price: 199 },
    { name: "Фасоль консервированная", price: 89 },
    { name: "Горошек консервированный", price: 79 },
    { name: "Кукуруза консервированная", price: 89 },
    { name: "Томатная паста 200г", price: 69 },
    { name: "Соус терияки 300мл", price: 199 },
    { name: "Соевый соус 500мл", price: 149 },
    { name: "Устричный соус 250мл", price: 249 },
    { name: "Кетчуп Heinz 500г", price: 299 },
    { name: "Майонез Провансаль", price: 119 },
    { name: "Сметана 15% 400г", price: 129 },
    { name: "Творожная масса 300г", price: 149 },
    { name: "Сыр плавленый 200г", price: 129 },
    { name: "Сыр моцарелла 250г", price: 299 },
    { name: "Сыр пармезан 100г", price: 199 },
    { name: "Сыр фета 200г", price: 249 },
    { name: "Сыр брынза 300г", price: 229 },
    { name: "Сыр голландский 200г", price: 199 },
    { name: "Сыр российский 300г", price: 249 },
    { name: "Сыр пеппер джек", price: 349 },
    { name: "Сыр чеддер 200г", price: 279 },
    { name: "Сыр гауда 200г", price: 259 },
    { name: "Сыр камамбер 150г", price: 399 },
    { name: "Сыр бри 150г", price: 449 },
    { name: "Сыр дорблю 200г", price: 499 },
    { name: "Сыр рокфор 150г", price: 599 },
    { name: "Сыр с плесенью", price: 549 },
    { name: "Сыр тофу 300г", price: 179 },
    { name: "Сыр веганский", price: 299 },
    { name: "Молоко миндальное 1л", price: 249 },
    { name: "Молоко овсяное 1л", price: 199 },
    { name: "Молоко кокосовое 1л", price: 299 },
    { name: "Йогурт греческий", price: 129 },
    { name: "Кефир 1л", price: 79 },
    { name: "Ряженка 1л", price: 89 },
    { name: "Простокваша 500мл", price: 59 },
    { name: "Снежок 500мл", price: 69 },
    { name: "Бифидок 500мл", price: 79 },
    { name: "Ацидофилин 500мл", price: 69 },
    { name: "Молочный коктейль", price: 99 },
    { name: "Молочный шоколад", price: 89 },
    { name: "Горький шоколад", price: 129 },
    { name: "Белый шоколад", price: 119 },
    { name: "Шоколад с орехами", price: 149 },
    { name: "Шоколад с изюмом", price: 139 },
    { name: "Шоколад Kinder", price: 99 },
    { name: "Шоколад Milka", price: 129 },
    { name: "Шоколад Alpen Gold", price: 89 },
    { name: "Шоколад Ritter Sport", price: 149 },
    { name: "Шоколад Lindt", price: 199 },
    { name: "Шоколад Ferrero Rocher", price: 399 },
    { name: "Конфеты Ассорти", price: 299 },
    { name: "Конфеты Мишка на Севере", price: 129 },
    { name: "Конфеты Белочка", price: 99 },
    { name: "Конфеты Коровка", price: 89 },
    { name: "Конфеты Красная цена", price: 149 },
    { name: "Конфеты Рафаэлло", price: 299 },
    { name: "Конфеты Бон Пари", price: 179 },
    { name: "Конфеты Черри Берри", price: 159 },
    { name: "Конфеты Мишка косолапый", price: 119 },
    { name: "Конфеты Клубника со сливками", price: 139 },
    { name: "Конфеты Ласточка", price: 99 },
    { name: "Конфеты Барбарис", price: 79 },
    { name: "Конфеты Лимонные", price: 89 },
    { name: "Конфеты Апельсиновые", price: 89 },
    { name: "Конфеты Малиновые", price: 99 },
    { name: "Конфеты Черничные", price: 109 },
    { name: "Конфеты Вишнёвые", price: 99 },
    { name: "Конфеты Яблочные", price: 89 },
    { name: "Конфеты Грушевые", price: 99 },
    { name: "Конфеты Абрикосовые", price: 109 },
    { name: "Конфеты Персиковые", price: 109 },
    { name: "Конфеты Ананасовые", price: 119 },
    { name: "Конфеты Кокосовые", price: 129 },
    { name: "Конфеты Ореховые", price: 149 },
    { name: "Конфеты Карамельные", price: 79 },
    { name: "Конфеты Ириски", price: 69 },
    { name: "Конфеты Леденцы", price: 59 },
    { name: "Конфеты Жевательные", price: 89 },
    { name: "Конфеты Мармелад", price: 99 },
    { name: "Конфеты Зефир", price: 119 },
    { name: "Конфеты Пастила", price: 129 },
    { name: "Конфеты Халва", price: 149 },
    { name: "Конфеты Козинаки", price: 179 },
    { name: "Конфеты Пряники", price: 129 },
    { name: "Конфеты Печенье сгущенка", price: 109 },
    { name: "Конфеты Сникерс", price: 89 },
    { name: "Конфеты Марс", price: 89 },
    { name: "Конфеты Баунти", price: 89 },
    { name: "Конфеты Твикс", price: 89 },
    { name: "Конфеты Милки Вэй", price: 89 },
    { name: "Конфеты Кит Кат", price: 79 },
    { name: "Конфеты Тоблероне", price: 199 },
    { name: "Конфеты Натс", price: 129 },
    { name: "Конфеты Бабаевский", price: 149 },
    { name: "Конфеты Красный Октябрь", price: 159 },
    { name: "Конфеты Рот Фронт", price: 139 },
    { name: "Конфеты Сладков", price: 119 },
    { name: "Конфеты Сластена", price: 99 },
    { name: "Конфеты Сладкоежка", price: 109 },
    { name: "Конфеты Вкусняшка", price: 89 },
    { name: "Конфеты Лакомка", price: 99 },
    { name: "Конфеты Сладость", price: 79 },
    { name: "Конфеты Угощение", price: 89 },
    { name: "Конфеты Деликатес", price: 129 },
    { name: "Конфеты Премиум", price: 199 },
    { name: "Конфеты Элит", price: 249 },
    { name: "Конфеты Люкс", price: 299 },
    { name: "Конфеты Империал", price: 349 },
    { name: "Конфеты Королевские", price: 399 },
    { name: "Конфеты Царские", price: 449 },
    { name: "Конфеты Императорские", price: 499 },
    { name: "Конфеты Золотые", price: 599 },
    { name: "Конфеты Платиновые", price: 699 },
    { name: "Конфеты Алмазные", price: 799 },
    { name: "Конфеты Бриллиантовые", price: 899 },
    { name: "Конфеты Сапфировые", price: 799 },
    { name: "Конфеты Изумрудные", price: 749 },
    { name: "Конфеты Рубиновые", price: 799 },
    { name: "Конфеты Аметистовые", price: 699 },
    { name: "Конфеты Ониксовые", price: 599 },
    { name: "Конфеты Жемчужные", price: 549 },
    { name: "Конфеты Перламутровые", price: 499 },
    { name: "Конфеты Серебряные", price: 449 },
    { name: "Конфеты Бронзовые", price: 399 },
    { name: "Конфеты Медные", price: 349 },
    { name: "Конфеты Железные", price: 299 },
    { name: "Конфеты Стальные", price: 249 },
    { name: "Конфеты Титановые", price: 199 },
    { name: "Конфеты Алюминиевые", price: 149 },
    { name: "Конфеты Пластиковые", price: 99 },
    { name: "Конфеты Бумажные", price: 79 },
    { name: "Конфеты Деревянные", price: 129 },
    { name: "Конфеты Каменные", price: 199 },
    { name: "Конфеты Стеклянные", price: 249 },
    { name: "Конфеты Хрустальные", price: 299 },
    { name: "Конфеты Фарфоровые", price: 349 },
    { name: "Конфеты Керамические", price: 299 },
    { name: "Конфеты Глиняные", price: 199 },
    { name: "Конфеты Гипсовые", price: 149 },
    { name: "Конфеты Цементные", price: 99 },
    { name: "Конфеты Бетонные", price: 129 },
    { name: "Конфеты Асфальтовые", price: 149 },
    { name: "Конфеты Гравийные", price: 99 },
    { name: "Конфеты Песочные", price: 79 },
    { name: "Конфеты Глинистые", price: 89 },
    { name: "Конфеты Иловые", price: 99 },
    { name: "Конфеты Торфяные", price: 129 },
    { name: "Конфеты Угольные", price: 149 },
    { name: "Конфеты Нефтяные", price: 199 },
    { name: "Конфеты Газовые", price: 249 },
    { name: "Конфеты Электрические", price: 299 },
    { name: "Конфеты Магнитные", price: 349 },
    { name: "Конфеты Гравитационные", price: 399 },
    { name: "Конфеты Квантовые", price: 499 },
    { name: "Конфеты Атомные", price: 599 },
    { name: "Конфеты Ядерные", price: 699 },
    { name: "Конфеты Термоядерные", price: 799 },
    { name: "Конфеты Аннигиляционные", price: 899 },
    { name: "Конфеты Чернодырочные", price: 999 },
    { name: "Конфеты Вселенские", price: 1999 },
    { name: "Конфеты Галактические", price: 1499 },
    { name: "Конфеты Звёздные", price: 999 },
    { name: "Конфеты Планетарные", price: 799 },
    { name: "Конфеты Лунные", price: 599 },
    { name: "Конфеты Солнечные", price: 499 },
    { name: "Конфеты Кометные", price: 399 },
    { name: "Конфеты Астероидные", price: 299 },
    { name: "Конфеты Метеоритные", price: 199 },
    { name: "Конфеты Космические", price: 149 },
    { name: "Конфеты НЛО", price: 129 },
    { name: "Конфеты Инопланетные", price: 199 },
    { name: "Конфеты Земные", price: 99 },
    { name: "Конфеты Водные", price: 89 },
    { name: "Конфеты Огненные", price: 129 },
    { name: "Конфеты Воздушные", price: 99 },
    { name: "Конфеты Эфирные", price: 149 },
    { name: "Конфеты Духовные", price: 199 },
    { name: "Конфеты Психические", price: 249 },
    { name: "Конфеты Ментальные", price: 299 },
    { name: "Конфеты Эмоциональные", price: 199 },
    { name: "Конфеты Чувственные", price: 149 },
    { name: "Конфеты Интуитивные", price: 129 },
    { name: "Конфеты Логические", price: 99 },
    { name: "Конфеты Математические", price: 149 },
    { name: "Конфеты Физические", price: 129 },
    { name: "Конфеты Химические", price: 119 },
    { name: "Конфеты Биологические", price: 109 },
    { name: "Конфеты Географические", price: 99 },
    { name: "Конфеты Исторические", price: 129 },
    { name: "Конфеты Литературные", price: 149 },
    { name: "Конфеты Поэтические", price: 129 },
    { name: "Конфеты Музыкальные", price: 119 },
    { name: "Конфеты Художественные", price: 139 },
    { name: "Конфеты Театральные", price: 149 },
    { name: "Конфеты Кино", price: 159 },
    { name: "Конфеты ТВ", price: 129 },
    { name: "Конфеты Радио", price: 99 },
    { name: "Конфеты Интернет", price: 89 },
    { name: "Конфеты Соцсети", price: 79 },
    { name: "Конфеты Мессенджеры", price: 69 },
    { name: "Конфеты Почта", price: 59 },
    { name: "Конфеты Телефон", price: 89 },
    { name: "Конфеты Смартфон", price: 129 },
    { name: "Конфеты Планшет", price: 149 },
    { name: "Конфеты Ноутбук", price: 199 },
    { name: "Конфеты Компьютер", price: 249 },
    { name: "Конфеты Сервер", price: 299 },
    { name: "Конфеты Облако", price: 199 },
    { name: "Конфеты Данные", price: 149 },
    { name: "Конфеты Информация", price: 129 },
    { name: "Конфеты Знания", price: 199 },
    { name: "Конфеты Мудрость", price: 299 },
    { name: "Конфеты Истина", price: 399 },
    { name: "Конфеты Реальность", price: 499 },
    { name: "Конфеты Иллюзия", price: 399 },
    { name: "Конфеты Сон", price: 299 },
    { name: "Конфеты Явь", price: 199 },
    { name: "Конфеты Бодрствование", price: 149 },
    { name: "Конфеты Сонливость", price: 99 },
    { name: "Конфеты Бессонница", price: 129 },
    { name: "Конфеты Кошмар", price: 149 },
    { name: "Конфеты Сказка", price: 129 },
    { name: "Конфеты Миф", price: 119 },
    { name: "Конфеты Легенда", price: 109 },
    { name: "Конфеты Быль", price: 99 },
    { name: "Конфеты Небылица", price: 89 },
    { name: "Конфеты Анекдот", price: 79 },
    { name: "Конфеты Шутка", price: 69 },
    { name: "Конфеты Юмор", price: 89 },
    { name: "Конфеты Смех", price: 99 },
    { name: "Конфеты Улыбка", price: 79 },
    { name: "Конфеты Счастье", price: 199 },
    { name: "Конфеты Радость", price: 149 },
    { name: "Конфеты Любовь", price: 299 },
    { name: "Конфеты Дружба", price: 129 },
    { name: "Конфеты Семья", price: 149 },
    { name: "Конфеты Родина", price: 199 },
    { name: "Конфеты Мир", price: 299 },
    { name: "Конфеты Свобода", price: 399 },
    { name: "Конфеты Равенство", price: 299 },
    { name: "Конфеты Братство", price: 199 },
    { name: "Конфеты Справедливость", price: 249 },
    { name: "Конфеты Честь", price: 199 },
    { name: "Конфеты Достоинство", price: 179 },
    { name: "Конфеты Уважение", price: 149 },
    { name: "Конфеты Доброта", price: 129 },
    { name: "Конфеты Щедрость", price: 119 },
    { name: "Конфеты Милосердие", price: 109 },
    { name: "Конфеты Сострадание", price: 99 },
    { name: "Конфеты Сочувствие", price: 89 },
    { name: "Конфеты Эмпатия", price: 129 },
    { name: "Конфеты Симпатия", price: 99 },
    { name: "Конфеты Антипатия", price: 79 },
    { name: "Конфеты Ненависть", price: 199 },
    { name: "Конфеты Злоба", price: 149 },
    { name: "Конфеты Зависть", price: 129 },
    { name: "Конфеты Гордость", price: 119 },
    { name: "Конфеты Тщеславие", price: 109 },
    { name: "Конфеты Скупость", price: 99 },
    { name: "Конфеты Жадность", price: 129 },
    { name: "Конфеты Алчность", price: 149 },
    { name: "Конфеты Лень", price: 89 },
    { name: "Конфеты Апатия", price: 79 },
    { name: "Конфеты Безразличие", price: 69 },
    { name: "Конфеты Равнодушие", price: 59 },
    { name: "Конфеты Скука", price: 49 },
    { name: "Конфеты Уныние", price: 89 },
    { name: "Конфеты Одиночество", price: 99 },
    { name: "Конфеты Печаль", price: 79 },
    { name: "Конфеты Грусть", price: 69 },
    { name: "Конфеты Тоска", price: 89 },
    { name: "Конфеты Ностальгия", price: 99 },
    { name: "Конфеты Тревога", price: 109 },
    { name: "Конфеты Страх", price: 119 },
    { name: "Конфеты Ужас", price: 129 },
    { name: "Конфеты Паника", price: 139 },
    { name: "Конфеты Беспокойство", price: 99 },
    { name: "Конфеты Волнение", price: 89 },
    { name: "Конфеты Возбуждение", price: 109 },
    { name: "Конфеты Эйфория", price: 149 },
    { name: "Конфеты Восторг", price: 129 },
    { name: "Конфеты Восхищение", price: 119 },
    { name: "Конфеты Удивление", price: 99 },
    { name: "Конфеты Изумление", price: 109 },
    { name: "Конфеты Поражение", price: 89 },
    { name: "Конфеты Победа", price: 199 },
    { name: "Конфеты Успех", price: 179 },
    { name: "Конфеты Неудача", price: 99 },
    { name: "Конфеты Провал", price: 89 },
    { name: "Конфеты Крах", price: 129 },
    { name: "Конфеты Разгром", price: 119 },
    { name: "Конфеты Поражение", price: 109 },
    { name: "Конфеты Триумф", price: 299 },
    { name: "Конфеты Лавры", price: 199 },
    { name: "Конфеты Венец", price: 249 },
    { name: "Конфеты Корона", price: 299 },
    { name: "Конфеты Скипетр", price: 349 },
    { name: "Конфеты Держава", price: 399 },
    { name: "Конфеты Империя", price: 499 },
    { name: "Конфеты Царство", price: 399 },
    { name: "Конфеты Королевство", price: 349 },
    { name: "Конфеты Герцогство", price: 299 },
    { name: "Конфеты Княжество", price: 249 },
    { name: "Конфеты Баронство", price: 199 },
    { name: "Конфеты Лордство", price: 179 },
    { name: "Конфеты Сэргство", price: 149 },
    { name: "Конфеты Рыцарство", price: 129 },
    { name: "Конфеты Орден", price: 199 },
    { name: "Конфеты Медаль", price: 149 },
    { name: "Конфеты Награда", price: 129 },
    { name: "Конфеты Приз", price: 119 },
    { name: "Конфеты Кубок", price: 199 },
    { name: "Конфеты Трофей", price: 249 },
    { name: "Конфеты Лауреат", price: 299 },
    { name: "Конфеты Номинант", price: 199 },
    { name: "Конфеты Претендент", price: 149 },
    { name: "Конфеты Кандидат", price: 129 },
    { name: "Конфеты Соискатель", price: 119 },
    { name: "Конфеты Претендентка", price: 129 },
    { name: "Конфеты Претендентша", price: 119 },
    { name: "Конфеты Претенденты", price: 149 },
    { name: "Конфеты Претендентки", price: 139 },
    { name: "Конфеты Претендентши", price: 129 },
    { name: "Конфеты Претендентство", price: 199 },
    { name: "Конфеты Претензия", price: 99 },
    { name: "Конфеты Претенциозность", price: 129 },
    { name: "Конфеты Претенциозность", price: 129 },
    { name: "Пакет", price: 5 }
  ];

  // Расширим до 250+ товаров
  const products = [];
  for (let i = 0; i < 250; i++) {
    const p = baseProducts[i % baseProducts.length];
    products.push({ ...p, id: i + 1 });
  }

  // === Функции ===
  function login() {
    const pwd = document.getElementById("password-input").value;
    if (pwd === CASHIER_PASSWORD) {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("cashier-screen").style.display = "flex";
      updateCart();
    } else {
      alert("Неверный пароль!");
    }
  }

  function showCatalog() {
    document.getElementById("product-catalog").style.display = "flex";
    const list = document.getElementById("product-list");
    list.innerHTML = "";
    products.forEach(p => {
      const div = document.createElement("div");
      div.className = "product-item";
      div.textContent = `${p.name} — ${p.price} ₽`;
      div.onclick = () => addProductToCart(p);
      list.appendChild(div);
    });
  }

  function closeCatalog() {
    document.getElementById("product-catalog").style.display = "none";
  }

  function generateEAN13(name, isBag = false) {
    if (isBag) return BAG_BARCODE;
    // Генерируем уникальный 12-значный код на основе времени и имени
    const now = Date.now().toString().slice(-9);
    const nameHash = name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
    let code = (now + nameHash).padEnd(12, '0').slice(0,12);
    // Вычисляем контрольную цифру
    let sum = 0;
    for (let i = 0; i < 12; i++) {
      sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
    }
    const check = (10 - (sum % 10)) % 10;
    return code + check;
  }

  function addProductToCart(product) {
    const isBag = product.name === "Пакет";
    const barcode = generateEAN13(product.name, isBag);
    const item = { ...product, barcode, quantity: 1 };
    cart.push(item);
    updateCart();
    closeCatalog();

    // Автоматически добавить в корзину при "сканировании"
    console.log(`Сканирован штрихкод: ${barcode} → добавлено в корзину`);
  }

  function updateCart() {
    const cartEl = document.getElementById("cart-items");
    cartEl.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        ${item.name} × ${item.quantity} — ${item.price} ₽
        <button class="btn btn-danger" onclick="removeFromCart(${item.id})">Удалить</button>
      `;
      cartEl.appendChild(div);
      total += item.price * item.quantity;
    });
    document.getElementById("total").textContent = total;
    updateBonusDisplay();
  }

  function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    updateCart();
  }

  function openLoyalty() {
    document.getElementById("loyalty-form").style.display = "block";
    document.getElementById("loyalty-actions").innerHTML = `
      <button class="btn btn-primary" onclick="checkLoyalty()">Проверить карту</button>
      <button class="btn btn-danger" onclick="document.getElementById('loyalty-form').style.display='none'">Отмена</button>
    `;
  }

  function checkLoyalty() {
    const phone = document.getElementById("phone-input").value.replace(/\D/g, '');
    if (phone.length !== 11 || !phone.startsWith('7')) {
      alert("Введите корректный номер телефона (79991234567)");
      return;
    }

    db.ref('loyalty/' + phone).once('value').then(snapshot => {
      if (snapshot.exists()) {
        loyaltyCard = snapshot.val();
        favoriteProduct = loyaltyCard.favorite;
        alert(`Карта найдена! Любимый продукт: ${favoriteProduct}`);
        document.getElementById("loyalty-form").style.display = "none";
      } else {
        document.getElementById("loyalty-actions").innerHTML = `
          <input type="text" id="fio-input" placeholder="ФИО полностью" style="width:100%; padding:10px; margin:10px 0;" />
          <select id="fav-select" style="width:100%; padding:10px; margin:10px 0;">
            ${products.filter(p => p.name !== "Пакет").map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
          </select>
          <button class="btn btn-success" onclick="registerLoyalty('${phone}')">Оформить карту</button>
          <button class="btn btn-danger" onclick="document.getElementById('loyalty-form').style.display='none'">Отмена</button>
        `;
      }
    });
  }

  function registerLoyalty(phone) {
    const fio = document.getElementById("fio-input").value.trim();
    const fav = document.getElementById("fav-select").value;
    if (!fio || !fav) {
      alert("Заполните все поля");
      return;
    }
    db.ref('loyalty/' + phone).set({
      phone: phone,
      fio: fio,
      favorite: fav,
      bonus: 0
    }).then(() => {
      loyaltyCard = { phone, fio, favorite: fav, bonus: 0 };
      favoriteProduct = fav;
      alert("Карта успешно оформлена!");
      document.getElementById("loyalty-form").style.display = "none";
    });
  }

  function updateBonusDisplay() {
    const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
    let bonusEarn = 0;
    cart.forEach(item => {
      const rate = (item.name === favoriteProduct) ? 0.05 : 0.02;
      bonusEarn += Math.floor(item.price * item.quantity * rate);
    });
    document.getElementById("bonus-display").textContent = bonusEarn;
  }

  function openPayment() {
    const total = parseFloat(document.getElementById("total").textContent);
    document.getElementById("pay-amount").textContent = total;
    const maxBonus = parseInt(document.getElementById("bonus-display").textContent);
    document.getElementById("max-bonus").textContent = maxBonus;
    document.getElementById("use-bonus").max = maxBonus;
    document.getElementById("use-bonus").value = Math.min(maxBonus, total);
    document.getElementById("payment-screen").style.display = "block";
  }

  function closePayment() {
    document.getElementById("payment-screen").style.display = "none";
  }

  function payCash() {
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const final = total - useBonus;
    const paid = prompt(`Сумма к оплате: ${final} ₽\nВведите сумму от покупателя:`);
    if (paid === null) return;
    const cash = parseFloat(paid);
    if (isNaN(cash) || cash < final) {
      alert("Недостаточно средств!");
      return;
    }
    const change = cash - final;
    generateReceipt(final, useBonus, "Наличные", change);
    savePurchaseToFirebase(final, useBonus, "cash");
    resetCart();
  }

  function payCard() {
    if (!confirm("Подтвердите оплату картой на сумму: " + document.getElementById("pay-amount").textContent + " ₽")) return;
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const final = total - useBonus;
    generateReceipt(final, useBonus, "Карта");
    savePurchaseToFirebase(final, useBonus, "card");
    resetCart();
  }

  function payQR() {
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const final = total - useBonus;
    const url = `https://renessans-bank.github.io/oplata/?amount=${final}`;
    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
      text: url,
      width: 200,
      height: 200
    });
    alert("Покажите QR-код покупателю для оплаты");
    // В реальном приложении здесь был бы вебхук на оплату
    setTimeout(() => {
      generateReceipt(final, useBonus, "QR");
      savePurchaseToFirebase(final, useBonus, "qr");
      resetCart();
    }, 5000); // имитация оплаты
  }

  function generateReceipt(finalSum, usedBonus, method, change = 0) {
    const now = new Date().toLocaleString("ru-RU");
    let receipt = `          ООО «Пятёрка»\n`;
    receipt += `ИНН 940953867509\n`;
    receipt += `Кассир: Василькова О.Н.\n`;
    receipt += `Дата: ${now}\n`;
    receipt += `--------------------------\n`;
    cart.forEach(item => {
      receipt += `${item.name}\n`;
      receipt += `      ${item.price} ₽ x${item.quantity}\n`;
    });
    receipt += `--------------------------\n`;
    receipt += `Итого: ${finalSum + usedBonus} ₽\n`;
    if (usedBonus > 0) receipt += `Бонусы: -${usedBonus} ₽\n`;
    receipt += `К оплате: ${finalSum} ₽\n`;
    receipt += `Оплата: ${method}\n`;
    if (change > 0) receipt += `Сдача: ${change} ₽\n`;
    receipt += `--------------------------\n`;
    receipt += `Спасибо за покупку!\n`;

    document.getElementById("receipt-content").textContent = receipt;
    document.getElementById("payment-screen").style.display = "none";
    document.getElementById("receipt-screen").style.display = "block";
  }

  function savePurchaseToFirebase(sum, bonus, method) {
    const purchase = {
      timestamp: firebase.database.ServerValue.TIMESTAMP,
      items: cart,
      total: sum + bonus,
      paid: sum,
      bonusUsed: bonus,
      method: method,
      cashier: "Василькова О.Н."
    };
    db.ref('purchases').push(purchase);

    // Обновить бонусы в карте
    if (loyaltyCard && bonus > 0) {
      const earned = parseInt(document.getElementById("bonus-display").textContent);
      db.ref('loyalty/' + loyaltyCard.phone).update({ bonus: (loyaltyCard.bonus || 0) + earned });
    }
  }

  function printReceipt() {
    window.print();
  }

  function backToCashier() {
    document.getElementById("receipt-screen").style.display = "none";
    document.getElementById("cashier-screen").style.display = "flex";
  }

  function resetCart() {
    cart = [];
    updateCart();
  }

  function resetSession() {
    if (confirm("Сбросить смену?")) {
      cart = [];
      loyaltyCard = null;
      favoriteProduct = null;
      updateCart();
    }
  }

  // === Горячие клавиши ===
  document.addEventListener('keydown', (e) => {
    if (e.key === 'F2' && document.getElementById("cashier-screen").style.display === "flex") {
      e.preventDefault();
      showCatalog();
    }
  });

  // === Старт ===
  document.getElementById("login-screen").style.display = "flex";
</script>

</body>
</html>
