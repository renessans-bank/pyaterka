<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞—Å—Å–∞ –ü—è—Ç—ë—Ä–∫–∞</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 15px; max-width: 800px; margin: 0 auto; background: #f9f9f9; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    button {
      width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 6px;
      background: #3498db; color: white; font-size: 15px; cursor: pointer;
    }
    .btn-secondary { background: #95a5a6; }
    .btn-success { background: #2ecc71; }
    .btn-danger { background: #e74c3c; }
    button:hover { opacity: 0.9; }
    input, select {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px;
    }
    .hidden { display: none; }
    .receipt, .archive-item, .barcode-print-area {
      background: white; padding: 15px; margin: 15px 0; border-radius: 8px;
    }
    #barcode-svg { width: 100%; height: auto; margin: 15px 0; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    .scan-layout { display: flex; gap: 15px; }
    .scan-main { flex: 2; }
    .scan-sidebar { flex: 1; background: #ecf0f1; padding: 15px; border-radius: 8px; }
    @media print {
      body * { display: none; }
      .barcode-print-area, .barcode-print-area * { display: block !important; }
    }
    #hidden-input {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="screen-login">
  <h2>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
  <form id="loginForm">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" />
    <button type="submit">–í–æ–π—Ç–∏</button>
  </form>
</div>

<!-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω) -->
<div id="screen-scan" class="hidden">
  <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h2>
  <div class="scan-layout">
    <div class="scan-main">
      <p>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–≤–æ–¥–Ω—ã–º —Å–∫–∞–Ω–µ—Ä–æ–º</p>
      <input type="text" id="hidden-input" autocomplete="off" autofocus />
      <div id="scanned-items" style="min-height: 150px; background: white; padding: 10px; border-radius: 6px; margin: 10px 0;"></div>
      <button id="btn-pay">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
    <div class="scan-sidebar">
      <h3>–†—É—á–Ω–æ–π –≤–≤–æ–¥</h3>
      <input type="text" id="manual-barcode" placeholder="–®—Ç—Ä–∏—Ö–∫–æ–¥" />
      <button id="btn-add-manual">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      <h3>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h3>
      <input type="tel" id="loyalty-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <button id="btn-apply-loyalty">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –û–ø–ª–∞—Ç–∞ -->
<div id="screen-payment" class="hidden">
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
  <div id="cart-summary"></div>
  <button id="btn-pay-cash">üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏</button>
  <button id="btn-pay-card">üí≥ –ö–∞—Ä—Ç–æ–π</button>
  <button id="btn-pay-qr">üì± QR-–æ–ø–ª–∞—Ç–∞</button>
  <button id="btn-back-payment">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
<div id="screen-cash" class="hidden">
  <h2>–ù–∞–ª–∏—á–Ω—ã–µ</h2>
  <input type="number" id="cash-given" placeholder="–°–∫–æ–ª—å–∫–æ –¥–∞–ª –ø–æ–∫—É–ø–∞—Ç–µ–ª—å?" step="0.01" />
  <p id="change-info"></p>
  <button id="btn-complete-cash">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<!-- –ö–∞—Ä—Ç–∞ -->
<div id="screen-card" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</h2>
  <p>–°—É–º–º–∞: <span id="card-total">0.00</span> ‚ÇΩ</p>
  <p style="color:#e74c3c;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É</p>
  <button id="btn-confirm-card" class="btn-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
</div>

<!-- QR-–æ–ø–ª–∞—Ç–∞ -->
<div id="screen-qr" class="hidden">
  <h2>QR-–æ–ø–ª–∞—Ç–∞</h2>
  <p>–ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é</p>
  <div id="qr-code" style="text-align:center; margin:20px 0;"></div>
  <p id="qr-status">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...</p>
  <button id="btn-cancel-qr">–û—Ç–º–µ–Ω–∏—Ç—å</button>
</div>

<!-- –ê—Ä—Ö–∏–≤ -->
<div id="screen-archive" class="hidden">
  <h2>–ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫</h2>
  <button id="btn-back-archive">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="archive-list"></div>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
<div id="screen-generate" class="hidden">
  <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>
  <div id="product-list" style="max-height: 400px; overflow-y: auto;"></div>
  <div id="generated-barcode" class="hidden">
    <svg id="barcode-svg"></svg>
    <p id="barcode-text"></p>
  </div>
  <button id="btn-back-generate">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ß–µ–∫ -->
<div id="screen-receipt" class="hidden">
  <div class="receipt" id="receipt-content"></div>
  <button id="btn-new-sale">‚ûï –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</button>
</div>

<script>
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const ACCESS_PASSWORD = '0506';
const CASHIER_NAME = '–§—Ä–æ–ª–æ–≤ –Æ—Ä–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á';
const INN = '0109764890';
const DATABASE_URL = 'https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/';
const BONUS_RATE_REGULAR = 0.02;

// ~~~~~~~~~~~~~~~~~~~~~ –¢–û–í–ê–†–´ (150+) ~~~~~~~~~~~~~~~~~~~~~~~~~
const PRODUCTS = [
{name:"–ü–∞–∫–µ—Ç",price:3.00},{name:"–ú–æ–ª–æ–∫–æ 1–ª",price:119.90},{name:"–•–ª–µ–± –±–µ–ª—ã–π",price:64.50},{name:"–Ø–π—Ü–∞ 10 —à—Ç",price:149.00},
{name:"–°—ã—Ä 200–≥",price:249.90},{name:"–ö–æ–ª–∞ 0.5–ª",price:89.00},{name:"–®–æ–∫–æ–ª–∞–¥",price:95.50},
{name:"–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ",price:189.00},{name:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å 1–∫–≥",price:45.00},{name:"–°–∞—Ö–∞—Ä 1–∫–≥",price:79.90},
{name:"–ß–∞–π —á–µ—Ä–Ω—ã–π",price:210.00},{name:"–†–∏—Å 1–∫–≥",price:120.00},{name:"–ö–æ—Ñ–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π",price:350.00},
{name:"–ü–µ—á–µ–Ω—å–µ",price:85.00},{name:"–°–æ–∫ 1–ª",price:130.00},{name:"–ú–∞–∫–∞—Ä–æ–Ω—ã",price:65.00},
{name:"–ö–µ—Ç—á—É–ø",price:110.00},{name:"–ú–∞–π–æ–Ω–µ–∑",price:125.00},{name:"–°–∞–ª—Ñ–µ—Ç–∫–∏",price:40.00},
{name:"–ó—É–±–Ω–∞—è –ø–∞—Å—Ç–∞",price:160.00},{name:"–®–∞–º–ø—É–Ω—å",price:290.00},{name:"–í–æ–¥–∞ 1.5–ª",price:55.00},
{name:"–ü–µ–ª—å–º–µ–Ω–∏",price:220.00},{name:"–°–º–µ—Ç–∞–Ω–∞ 200–≥",price:99.00},{name:"–¢–≤–æ—Ä–æ–≥ 500–≥",price:180.00},
{name:"–ö–µ—Ñ–∏—Ä 1–ª",price:85.00},{name:"–°–æ—Å–∏—Å–∫–∏",price:190.00},{name:"–ì—Ä–µ—á–∫–∞ 1–∫–≥",price:95.00},
{name:"–û–≤—Å—è–Ω–∫–∞",price:110.00},{name:"–ü–µ—á–µ–Ω—å–µ –æ–≤—Å—è–Ω–æ–µ",price:75.00},{name:"–°–≥—É—â—ë–Ω–∫–∞",price:130.00},
{name:"–ö–∞–∫–∞–æ",price:160.00},{name:"–ú—ë–¥ 500–≥",price:450.00},{name:"–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ",price:590.00}
];
// –î–æ–±–∞–≤–∏–º –¥–æ 150
while (PRODUCTS.length < 150) {
  PRODUCTS.push({ name: `–¢–æ–≤–∞—Ä ${PRODUCTS.length + 1}`, price: parseFloat((50 + Math.random() * 950).toFixed(2)) });
}

// ~~~~~~~~~~~~~~~~~~~~~ FIREBASE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const firebaseConfig = { databaseURL: DATABASE_URL };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ~~~~~~~~~~~~~~~~~~~~~ –ì–õ–û–ë–ê–õ–¨–ù–´–ï ~~~~~~~~~~~~~~~~~~~~~~~~~~~
let cart = [];
let loyaltyPhone = '';
let currentSessionId = Date.now().toString();
let qrCheckInterval = null;

// ~~~~~~~~~~~~~~~~~~~~~ –£–¢–ò–õ–ò–¢–´ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function generateEAN13() {
  const prefix = '200';
  const random = Math.floor(Math.random() * 1e9).toString().padStart(9, '0');
  const base = prefix + random;
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    const d = parseInt(base[i], 10);
    sum += d * (i % 2 === 0 ? 1 : 3);
  }
  const check = (10 - (sum % 10)) % 10;
  return base + check;
}

function showScreen(id) {
  document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function calculateChange(cash, total) {
  return parseFloat((cash - total).toFixed(2));
}

function renderCartSummary() {
  let total = 0;
  cart.forEach(item => total += item.price);
  document.getElementById('cart-summary').innerHTML = `
    <h3>–¢–æ–≤–∞—Ä—ã (${cart.length})</h3>
    <p>–ò—Ç–æ–≥–æ: ${total.toFixed(2)} ‚ÇΩ</p>
  `;
  document.getElementById('card-total').textContent = total.toFixed(2);
}

// ~~~~~~~~~~~~~~~~~~~~~ FIREBASE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
async function addProductToDB(product, barcode) {
  await db.ref('products/' + barcode).set({ name: product.name, price: product.price, used: false });
}

async function getProductByBarcode(barcode) {
  const snap = await db.ref('products/' + barcode).once('value');
  return snap.exists() ? { barcode, ...snap.val() } : null;
}

async function markAsUsed(barcode) {
  await db.ref('products/' + barcode).update({ used: true });
}

async function saveReceipt(receipt) {
  await db.ref('receipts').push(receipt);
}

async function getReceipts() {
  const snap = await db.ref('receipts').once('value');
  return snap.val() ? Object.values(snap.val()) : [];
}

// ~~~~~~~~~~~~~~~~~~~~~ –û–ë–†–ê–ë–û–¢–ö–ê –®–¢–†–ò–•–ö–û–î–ê ~~~~~~~~~~~~~~~~~~
async function processBarcode(rawInput) {
  let clean = rawInput.replace(/\D/g, '');
  if (clean.length > 13) clean = clean.slice(-13);
  if (clean.length !== 13) return;

  const prod = await getProductByBarcode(clean);
  if (!prod || prod.used) return;

  await markAsUsed(clean);
  cart.push({ ...prod, quantity: 1 });

  const div = document.createElement('div');
  div.textContent = `‚úÖ ${prod.name} ‚Äî ${prod.price.toFixed(2)} ‚ÇΩ`;
  document.getElementById('scanned-items').appendChild(div);

  renderCartSummary();
}

// ~~~~~~~~~~~~~~~~~~~~~ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('loginForm').addEventListener('submit', e => {
  e.preventDefault();
  if (document.getElementById('password').value === ACCESS_PASSWORD) {
    showScreen('screen-scan');
    document.getElementById('hidden-input').focus();
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('hidden-input').addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const value = e.target.value.trim();
    e.target.value = '';
    if (value) await processBarcode(value);
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –†–£–ß–ù–û–ô –í–í–û–î ~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-add-manual').addEventListener('click', async () => {
  const value = document.getElementById('manual-barcode').value.trim();
  if (value) {
    document.getElementById('manual-barcode').value = '';
    await processBarcode(value);
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –õ–û–Ø–õ–¨–ù–û–°–¢–¨ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-apply-loyalty').addEventListener('click', () => {
  loyaltyPhone = document.getElementById('loyalty-phone').value || '';
  alert('–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞');
});

// ~~~~~~~~~~~~~~~~~~~~~ –û–ü–õ–ê–¢–ê ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-pay').addEventListener('click', () => {
  if (cart.length === 0) return alert('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤');
  renderCartSummary();
  showScreen('screen-payment');
});

document.getElementById('btn-back-payment').addEventListener('click', () => showScreen('screen-scan'));

// ~~~~~~~~~~~~~~~~~~~~~ –°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´ ~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-pay-cash').addEventListener('click', () => showScreen('screen-cash'));
document.getElementById('btn-pay-card').addEventListener('click', () => showScreen('screen-card'));

// ~~~~~~~~~~~~~~~~~~~~~ QR-–û–ü–õ–ê–¢–ê ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-pay-qr').addEventListener('click', async () => {
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const sessionId = Date.now().toString();

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
  await db.ref('qr_sessions/' + sessionId).set({
    total,
    status: 'pending',
    timestamp: Date.now()
  });

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ data-url
  const qrPage = `
    <!DOCTYPE html>
    <html>
    <head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
    <title>–û–ø–ª–∞—Ç–∞</title>
    <style>body{font-family:sans-serif;text-align:center;padding:20px;}</style>
    </head>
    <body>
      <h2>–û–ø–ª–∞—Ç–∞ –≤ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
      <p>–°—É–º–º–∞: <strong>${total.toFixed(2)} ‚ÇΩ</strong></p>
      <button onclick="pay()" style="padding:15px;font-size:18px;background:#2ecc71;color:white;border:none;border-radius:8px;">‚úÖ –û–ø–ª–∞—Ç–∏—Ç—å</button>
      <script>
        function pay() {
          fetch('https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/qr_sessions/${sessionId}.json', {
            method: 'PATCH',
            body: JSON.stringify({status: 'paid'})
          }).then(() => {
            alert('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!');
            window.close();
          });
        }
      <\/script>
    </body>
    </html>
  `;

  const qrUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(qrPage);
  const qrImg = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}" />`;
  document.getElementById('qr-code').innerHTML = qrImg;
  document.getElementById('qr-status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';

  showScreen('screen-qr');

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
  qrCheckInterval = setInterval(async () => {
    const snap = await db.ref('qr_sessions/' + sessionId).once('value');
    if (snap.exists() && snap.val().status === 'paid') {
      clearInterval(qrCheckInterval);
      await finalizeSale('qr');
    }
  }, 2000);
});

document.getElementById('btn-cancel-qr').addEventListener('click', () => {
  if (qrCheckInterval) clearInterval(qrCheckInterval);
  showScreen('screen-payment');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ó–ê–í–ï–†–®–ï–ù–ò–ï –ü–†–û–î–ê–ñ–ò ~~~~~~~~~~~~~~~~~~~
async function finalizeSale(paymentMethod) {
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const receipt = {
    items: cart,
    total,
    paymentMethod,
    loyaltyPhone,
    cashier: CASHIER_NAME,
    inn: INN,
    timestamp: Date.now()
  };
  await saveReceipt(receipt);
  renderReceipt(receipt);
  showScreen('screen-receipt');
}

// ~~~~~~~~~~~~~~~~~~~~~ –ù–ê–õ–ò–ß–ù–´–ï / –ö–ê–†–¢–ê ~~~~~~~~~~~~~~~~~~~~~
document.getElementById('cash-given').addEventListener('input', () => {
  const cash = parseFloat(document.getElementById('cash-given').value);
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const info = document.getElementById('change-info');
  if (!isNaN(cash) && cash >= total) {
    info.textContent = `–°–¥–∞—á–∞: ${calculateChange(cash, total).toFixed(2)} ‚ÇΩ`;
    info.style.color = 'green';
  } else {
    info.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!';
    info.style.color = 'red';
  }
});

document.getElementById('btn-complete-cash').addEventListener('click', async () => {
  const cash = parseFloat(document.getElementById('cash-given').value);
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  if (isNaN(cash) || cash < total) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
  await finalizeSale('cash');
});

document.getElementById('btn-confirm-card').addEventListener('click', async () => {
  await finalizeSale('card');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ß–ï–ö ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function renderReceipt(r) {
  let html = `<h2 style="text-align:center">–ö–ê–°–°–û–í–´–ô –ß–ï–ö</h2><p><strong>–ò–ù–ù:</strong> ${r.inn}</p><p><strong>–ö–∞—Å—Å–∏—Ä:</strong> ${r.cashier}</p><hr>`;
  r.items.forEach(i => {
    html += `<p>${i.name} ‚Äî ${i.price.toFixed(2)} ‚ÇΩ</p>`;
  });
  html += `<hr><p><strong>–ò–¢–û–ì–û:</strong> ${r.total.toFixed(2)} ‚ÇΩ</p>`;
  html += `<p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${r.paymentMethod === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : r.paymentMethod === 'card' ? '–ö–∞—Ä—Ç–∞' : 'QR'}</p>`;
  html += `<p><strong>–î–∞—Ç–∞:</strong> ${new Date(r.timestamp).toLocaleString('ru-RU')}</p>`;
  document.getElementById('receipt-content').innerHTML = html;
}

document.getElementById('btn-new-sale').addEventListener('click', () => {
  cart = []; loyaltyPhone = ''; currentSessionId = Date.now().toString();
  document.getElementById('scanned-items').innerHTML = '';
  document.getElementById('loyalty-phone').value = '';
  showScreen('screen-scan');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ê–†–•–ò–í (F2) ~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-back-archive').addEventListener('click', () => showScreen('screen-scan'));

document.addEventListener('keydown', async (e) => {
  if (e.key === 'F2') {
    const receipts = await getReceipts();
    const list = document.getElementById('archive-list');
    list.innerHTML = '<h3>–ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫</h3>';
    receipts.reverse().forEach(r => {
      const div = document.createElement('div');
      div.className = 'archive-item';
      div.innerHTML = `
        <p><strong>${new Date(r.timestamp).toLocaleString('ru-RU')}</strong></p>
        <p>–°—É–º–º–∞: ${r.total.toFixed(2)} ‚ÇΩ</p>
        <p>–û–ø–ª–∞—Ç–∞: ${r.paymentMethod}</p>
      `;
      list.appendChild(div);
    });
    showScreen('screen-archive');
  }

  // Alt ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
  if (e.altKey && !e.ctrlKey && !e.shiftKey) {
    e.preventDefault();
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    PRODUCTS.forEach(p => {
      const btn = document.createElement('button');
      btn.textContent = `${p.name} ‚Äî ${p.price.toFixed(2)} ‚ÇΩ`;
      btn.onclick = async () => {
        const barcode = generateEAN13();
        await addProductToDB(p, barcode);
        JsBarcode("#barcode-svg", barcode, { format: "EAN13", height: 80 });
        document.getElementById('barcode-text').textContent = barcode;
        document.getElementById('generated-barcode').classList.remove('hidden');
      };
      list.appendChild(btn);
    });
    showScreen('screen-generate');
  }
});

document.getElementById('btn-back-generate').addEventListener('click', () => showScreen('screen-scan'));

// ~~~~~~~~~~~~~~~~~~~~~ –ó–ê–ü–£–°–ö ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
showScreen('screen-login');
</script>
</body>
</html>
