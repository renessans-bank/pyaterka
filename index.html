<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f8f9fa; color: #333; }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; overflow: auto; }

    #login-screen { display: flex; background: #1e3a8a; color: white; justify-content: center; align-items: center; flex-direction: column; }
    #barcode-screen { background: #e0e0e0 !important; } /* –°–ï–†–´–ô –§–û–ù */

    input, button, select { padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #3b82f6; color: white; border: none; }
    button:hover { opacity: 0.9; }
    .btn-danger { background: #ef4444; }
    .btn-success { background: #10b981; }
    .btn-warning { background: #f59e0b; }
    .cart-item, .product-item { padding: 14px; margin: 8px 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .product-item { cursor: pointer; }
    .product-item:hover { background: #f0f9ff; }

    #barcode-preview {
      text-align: center;
      margin: 30px auto;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      max-width: 500px;
      border: 1px solid #ccc;
    }
    #barcode-number {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      margin-top: 15px;
      color: #000;
      letter-spacing: 2px;
    }

    #barcode-input {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 320px;
      text-align: center;
      font-size: 18px;
      padding: 12px;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      background: white;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: none;
    }

    @media print {
      body * { display: none !important; }
      #barcode-preview, #barcode-svg, #barcode-number {
        display: block !important;
        color: black !important;
        position: static !important;
        transform: none !important;
        box-shadow: none !important;
        border: none !important;
        padding: 20px;
        max-width: 100% !important;
      }
    }
  </style>
</head>
<body>

<!-- –í—Ö–æ–¥ -->
<div id="login-screen" class="screen">
  <h2>üîê –ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
  <p>–ü–∞—Ä–æ–ª—å –∫–∞—Å—Å–∏—Ä–∞:</p>
  <input type="password" id="password-input" placeholder="0506" maxlength="4" autofocus />
  <button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<!-- –ö–∞—Å—Å–∞ -->
<div id="cashier-screen" class="screen">
  <h2>üõí –ö–∞—Å—Å–∞ ‚Äî –í–∞—Å–∏–ª—å–∫–æ–≤–∞ –û.–ù.</h2>
  <div>
    <button onclick="showCatalog()">F2 ‚Äî –ö–∞—Ç–∞–ª–æ–≥ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</button>
    <button class="btn-success" onclick="openLoyalty()">–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</button>
    <button class="btn-danger" onclick="resetSession()">–°–±—Ä–æ—Å</button>
  </div>
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cart-items"></div>
  <div style="margin-top: 15px;"><strong>–ò—Ç–æ–≥–æ: <span id="total">0</span> ‚ÇΩ</strong></div>
  <div><strong>–ë–æ–Ω—É—Å—ã: <span id="bonus-display">0</span></strong></div>
  <button class="btn-success" onclick="openPayment()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
</div>

<!-- –ö–∞—Ç–∞–ª–æ–≥ -->
<div id="catalog-screen" class="screen">
  <h2>üì¶ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>
  <button onclick="closeCatalog()">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="product-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;"></div>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ ‚Äî –°–ï–†–´–ô –§–û–ù -->
<div id="barcode-screen" class="screen">
  <h2>üñ®Ô∏è –®—Ç—Ä–∏—Ö–∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</h2>
  <p id="barcode-product-name" style="font-size: 18px; margin: 10px 0;"></p>
  <div id="barcode-preview">
    <svg id="barcode-svg"></svg>
    <p id="barcode-number"></p>
  </div>
  <button class="btn-warning" onclick="window.print()">–ü–µ—á–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</button>
  <button onclick="backToCatalog()">‚Üê –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä</button>
</div>

<!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
<div id="loyalty-form" class="screen">
  <h3>üí≥ –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h3>
  <input type="tel" id="phone-input" placeholder="79991234567" maxlength="11" />
  <div id="loyalty-actions"></div>
  <button class="btn-danger" onclick="document.getElementById('loyalty-form').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –û–ø–ª–∞—Ç–∞ -->
<div id="payment-screen" class="screen">
  <h3>üí≥ –û–ø–ª–∞—Ç–∞</h3>
  <p>–°—É–º–º–∞: <span id="pay-amount">0</span> ‚ÇΩ</p>
  <p>–ë–æ–Ω—É—Å—ã: <input type="number" id="use-bonus" min="0" value="0" style="width: 100px;" /> –∏–∑ <span id="max-bonus">0</span></p>
  <button class="btn-success" onclick="payCash()">–ù–∞–ª–∏—á–Ω—ã–µ</button>
  <button onclick="payCard()">–ö–∞—Ä—Ç–∞</button>
  <button onclick="payQR()">QR</button>
  <div id="qrcode"></div>
  <button class="btn-danger" onclick="closePayment()">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –ß–µ–∫ -->
<div id="receipt-screen" class="screen">
  <h2>üßæ –ß–µ–∫</h2>
  <pre id="receipt-content" style="background: white; padding: 20px; border-radius: 10px; font-family: monospace;"></pre>
  <button onclick="printReceipt()">–ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>
  <button class="btn-success" onclick="backToCashier()">–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞</button>
</div>

<input id="barcode-input" maxlength="13" placeholder="–í–≤–µ–¥–∏—Ç–µ 13 —Ü–∏—Ñ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞" autocomplete="off" />

<script>
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let cart = [];
  let loyaltyCard = null;
  let favoriteProduct = null;
  const CASHIER_PASSWORD = "0506";
  const BAG_BARCODE = "2000000000006";
  const activeBarcodes = {};

  // === –†–û–í–ù–û 60 –£–ù–ò–ö–ê–õ–¨–ù–´–• –¢–û–í–ê–†–û–í (–ë–ï–ó –ü–û–í–¢–û–†–û–í) ===
  const products = [
    { name: "–ú–æ–ª–æ–∫–æ 1–ª", price: 89 },
    { name: "–•–ª–µ–± –±–µ–ª—ã–π", price: 45 },
    { name: "–Ø–π—Ü–∞ 10 —à—Ç", price: 85 },
    { name: "–°—ã—Ä 200–≥", price: 199 },
    { name: "–ö–æ–ª–±–∞—Å–∞ –¥–æ–∫—Ç–æ—Ä—Å–∫–∞—è 300–≥", price: 249 },
    { name: "–ü–æ–º–∏–¥–æ—Ä—ã 1–∫–≥", price: 159 },
    { name: "–û–≥—É—Ä—Ü—ã 1–∫–≥", price: 139 },
    { name: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å 1–∫–≥", price: 39 },
    { name: "–õ—É–∫ 1–∫–≥", price: 35 },
    { name: "–°–∞—Ö–∞—Ä 1–∫–≥", price: 75 },
    { name: "–ú—É–∫–∞ 1–∫–≥", price: 65 },
    { name: "–ú–∞–∫–∞—Ä–æ–Ω—ã 400–≥", price: 59 },
    { name: "–†–∏—Å 1–∫–≥", price: 119 },
    { name: "–ß–∞–π —á–µ—Ä–Ω—ã–π 100–ø", price: 299 },
    { name: "–ö–æ—Ñ–µ –º–æ–ª–æ—Ç—ã–π 200–≥", price: 399 },
    { name: "–°–æ–∫ —è–±–ª–æ—á–Ω—ã–π 1–ª", price: 129 },
    { name: "–í–æ–¥–∞ 1.5–ª", price: 49 },
    { name: "–ü–∏–≤–æ 0.5–ª", price: 89 },
    { name: "–®–∞–º–ø—É–Ω—å 400–º–ª", price: 249 },
    { name: "–ó—É–±–Ω–∞—è –ø–∞—Å—Ç–∞", price: 129 },
    { name: "–¢—É–∞–ª–µ—Ç–Ω–∞—è –±—É–º–∞–≥–∞ 12—Ä", price: 199 },
    { name: "–°—Ç–∏—Ä–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ—à–æ–∫ 3–∫–≥", price: 499 },
    { name: "–ú—ã–ª–æ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–µ", price: 45 },
    { name: "–ë–∞—Ç–æ–Ω—á–∏–∫–∏ 3—à—Ç", price: 99 },
    { name: "–ß–∏–ø—Å—ã 150–≥", price: 89 },
    { name: "–®–æ–∫–æ–ª–∞–¥–∫–∞", price: 79 },
    { name: "–ü–µ—á–µ–Ω—å–µ 250–≥", price: 119 },
    { name: "–ô–æ–≥—É—Ä—Ç 150–≥", price: 49 },
    { name: "–¢–≤–æ—Ä–æ–≥ 500–≥", price: 159 },
    { name: "–°–º–µ—Ç–∞–Ω–∞ 200–≥", price: 79 },
    { name: "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ 200–≥", price: 189 },
    { name: "–ú–∞–π–æ–Ω–µ–∑ 400–≥", price: 129 },
    { name: "–ö–µ—Ç—á—É–ø 300–≥", price: 99 },
    { name: "–ì—Ä–µ—á–∫–∞ 1–∫–≥", price: 89 },
    { name: "–ü–µ—Ä–µ—Ü —á–µ—Ä–Ω—ã–π –º–æ–ª–æ—Ç—ã–π", price: 69 },
    { name: "–°–æ–ª—å 1–∫–≥", price: 25 },
    { name: "–£–∫—Å—É—Å 9% 500–º–ª", price: 45 },
    { name: "–ì–∞–∑–∏—Ä–æ–≤–∫–∞ 2–ª", price: 99 },
    { name: "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫ 0.45–ª", price: 129 },
    { name: "–ö–æ–Ω—Å–µ—Ä–≤—ã —Ä—ã–±–Ω—ã–µ", price: 159 },
    { name: "–ö–æ–Ω—Å–µ—Ä–≤—ã –º—è—Å–Ω—ã–µ", price: 179 },
    { name: "–ö—Ä—É–∞—Å—Å–∞–Ω", price: 59 },
    { name: "–ë—É–ª–æ—á–∫–∞ —Å –º–∞–∫–æ–º", price: 39 },
    { name: "–°—ã—Ä–æ–∫ –≥–ª–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", price: 29 },
    { name: "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ 100–≥", price: 69 },
    { name: "–°–∞–ª–∞—Ç –æ–ª–∏–≤—å–µ 400–≥", price: 249 },
    { name: "–ü–µ–ª—å–º–µ–Ω–∏ 1–∫–≥", price: 349 },
    { name: "–í–∞—Ä–µ–Ω–∏–∫–∏ 800–≥", price: 229 },
    { name: "–°–æ—Å–∏—Å–∫–∏ 400–≥", price: 199 },
    { name: "–ö—É—Ä–∏—Ü–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω–∞—è 1–∫–≥", price: 249 },
    { name: "–ì–æ–≤—è–¥–∏–Ω–∞ 1–∫–≥", price: 699 },
    { name: "–°–≤–∏–Ω–∏–Ω–∞ 1–∫–≥", price: 549 },
    { name: "–†—ã–±–∞ –º–æ—Ä–æ–∂–µ–Ω–∞—è 1–∫–≥", price: 399 },
    { name: "–ö—Ä–µ–≤–µ—Ç–∫–∏ 300–≥", price: 599 },
    { name: "–ú–∞—Å–ª–æ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ 1–ª", price: 139 },
    { name: "–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ 500–º–ª", price: 499 },
    { name: "–ú–µ–¥ 500–≥", price: 399 },
    { name: "–í–∞—Ä–µ–Ω—å–µ 400–≥", price: 199 },
    { name: "–ö–æ—Ñ–µ –≤ –∑–µ—Ä–Ω–∞—Ö 250–≥", price: 599 },
    { name: "–ö–∞–∫–∞–æ –ø–æ—Ä–æ—à–æ–∫ 200–≥", price: 149 },
    { name: "–ü–∞–∫–µ—Ç", price: 5 }
  ].map((p, i) => ({ ...p, id: i + 1 })); // 60 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

  // === –§—É–Ω–∫—Ü–∏–∏ ===
  function login() {
    if (document.getElementById("password-input").value === CASHIER_PASSWORD) {
      document.getElementById("login-screen").style.display = "none";
      showCashier();
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
    }
  }

  function showCashier() {
    document.getElementById("cashier-screen").style.display = "flex";
    document.getElementById("barcode-input").style.display = "block";
    updateCart();
  }

  function hideBarcodeInput() {
    document.getElementById("barcode-input").style.display = "none";
  }

  document.getElementById("barcode-input").addEventListener("input", function () {
    const val = this.value.trim();
    if (val.length === 13 && /^\d{13}$/.test(val)) {
      handleScannedBarcode(val);
      this.value = "";
    } else if (val.length > 13) {
      this.value = val.slice(0, 13);
    }
  });

  function handleScannedBarcode(barcode) {
    if (barcode === BAG_BARCODE) {
      addToCart({ name: "–ü–∞–∫–µ—Ç", price: 5, barcode: BAG_BARCODE });
      return;
    }
    if (activeBarcodes[barcode]) {
      addToCart({ ...activeBarcodes[barcode], barcode });
    } else {
      alert("–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω: " + barcode);
    }
  }

  function addToCart(item) {
    cart.push({ ...item, quantity: 1 });
    updateCart();
  }

  function showCatalog() {
    hideBarcodeInput();
    document.getElementById("catalog-screen").style.display = "flex";
    const list = document.getElementById("product-list");
    list.innerHTML = "";
    products.forEach(p => {
      const div = document.createElement("div");
      div.className = "product-item";
      div.textContent = `${p.name} ‚Äî ${p.price} ‚ÇΩ`;
      div.onclick = () => generateBarcodeFor(p);
      list.appendChild(div);
    });
  }

  function closeCatalog() {
    document.getElementById("catalog-screen").style.display = "none";
    showCashier();
  }

  function generateBarcodeFor(product) {
    let barcode;
    const isBag = product.name === "–ü–∞–∫–µ—Ç";
    if (isBag) {
      barcode = BAG_BARCODE;
    } else {
      const now = Date.now().toString().slice(-9);
      const nameHash = product.name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
      let code12 = (now + nameHash).padEnd(12, '0').slice(0,12);
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(code12[i]) * (i % 2 === 0 ? 1 : 3);
      }
      const check = (10 - (sum % 10)) % 10;
      barcode = code12 + check;
      activeBarcodes[barcode] = product;
    }

    document.getElementById("barcode-product-name").textContent = product.name;
    document.getElementById("barcode-number").textContent = barcode;
    JsBarcode("#barcode-svg", barcode, {
      format: "EAN13",
      lineColor: "#000",
      height: 60,
      fontSize: 16,
      displayValue: true,
      margin: 10
    });

    document.getElementById("catalog-screen").style.display = "none";
    document.getElementById("barcode-screen").style.display = "flex";
  }

  function backToCatalog() {
    document.getElementById("barcode-screen").style.display = "none";
    document.getElementById("catalog-screen").style.display = "flex";
  }

  function updateCart() {
    const el = document.getElementById("cart-items");
    el.innerHTML = "";
    let total = 0;
    cart.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `${item.name} ‚Äî ${item.price} ‚ÇΩ <button class="btn-danger" onclick="removeItem(${idx})">‚úï</button>`;
      el.appendChild(div);
      total += item.price;
    });
    document.getElementById("total").textContent = total;
    updateBonusDisplay();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    updateCart();
  }

  function openLoyalty() {
    document.getElementById("loyalty-form").style.display = "flex";
    document.getElementById("loyalty-actions").innerHTML = `<button onclick="checkLoyalty()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`;
  }

  function checkLoyalty() {
    const phone = document.getElementById("phone-input").value.replace(/\D/g, '');
    if (phone.length !== 11 || !phone.startsWith('7')) return alert("–§–æ—Ä–º–∞—Ç: 79991234567");
    db.ref('loyalty/' + phone).once('value').then(snap => {
      if (snap.exists()) {
        loyaltyCard = snap.val();
        favoriteProduct = loyaltyCard.favorite;
        alert("–ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞! –õ—é–±–∏–º—ã–π –ø—Ä–æ–¥—É–∫—Ç: " + favoriteProduct);
        document.getElementById("loyalty-form").style.display = "none";
      } else {
        document.getElementById("loyalty-actions").innerHTML = `
          <input type="text" id="fio-input" placeholder="–§–ò–û" />
          <select id="fav-select">${products.filter(p=>p.name!=="–ü–∞–∫–µ—Ç").map(p=>`<option>${p.name}</option>`).join('')}</select>
          <button class="btn-success" onclick="registerLoyalty('${phone}')">–û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É</button>
        `;
      }
    });
  }

  function registerLoyalty(phone) {
    const fio = document.getElementById("fio-input").value.trim();
    const fav = document.getElementById("fav-select").value;
    if (!fio || !fav) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    db.ref('loyalty/' + phone).set({ phone, fio, favorite: fav, bonus: 0 }).then(() => {
      loyaltyCard = { phone, fio, favorite: fav, bonus: 0 };
      favoriteProduct = fav;
      alert("–ö–∞—Ä—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!");
      document.getElementById("loyalty-form").style.display = "none";
    });
  }

  function updateBonusDisplay() {
    let bonus = 0;
    cart.forEach(item => {
      const rate = (item.name === favoriteProduct) ? 0.05 : 0.02;
      bonus += Math.floor(item.price * rate);
    });
    document.getElementById("bonus-display").textContent = bonus;
  }

  function openPayment() {
    const total = parseFloat(document.getElementById("total").textContent);
    const maxBonus = parseInt(document.getElementById("bonus-display").textContent);
    document.getElementById("pay-amount").textContent = total;
    document.getElementById("max-bonus").textContent = maxBonus;
    document.getElementById("use-bonus").max = maxBonus;
    document.getElementById("use-bonus").value = Math.min(maxBonus, total);
    document.getElementById("payment-screen").style.display = "flex";
  }

  function closePayment() {
    document.getElementById("payment-screen").style.display = "none";
    showCashier();
  }

  function payCash() {
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const final = total - useBonus;
    const paid = prompt(`–ö –æ–ø–ª–∞—Ç–µ: ${final} ‚ÇΩ\n–°–∫–æ–ª—å–∫–æ –≤–Ω–µ—Å–µ–Ω–æ?`);
    if (paid === null) return;
    const cash = parseFloat(paid);
    if (isNaN(cash) || cash < final) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!");
    const change = cash - final;
    generateReceipt(final, useBonus, "–ù–∞–ª–∏—á–Ω—ã–µ", change);
    savePurchase(final, useBonus, "cash");
    resetCart();
  }

  function payCard() {
    if (!confirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–æ–π?")) return;
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const final = total - useBonus;
    generateReceipt(final, useBonus, "–ö–∞—Ä—Ç–∞");
    savePurchase(final, useBonus, "card");
    resetCart();
  }

  function payQR() {
    const total = parseFloat(document.getElementById("pay-amount").textContent);
    const useBonus = parseInt(document.getElementById("use-bonus").value) || 0;
    const final = total - useBonus;
    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
      text: `https://renessans-bank.github.io/oplata/?amount=${final}`,
      width: 180, height: 180
    });
    alert("–ü–æ–∫–∞–∂–∏—Ç–µ QR –ø–æ–∫—É–ø–∞—Ç–µ–ª—é");
    setTimeout(() => {
      generateReceipt(final, useBonus, "QR");
      savePurchase(final, useBonus, "qr");
      resetCart();
    }, 4000);
  }

  function generateReceipt(sum, bonus, method, change = 0) {
    const now = new Date().toLocaleString("ru-RU");
    let txt = `          –û–û–û ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª\n–ò–ù–ù 940953867509\n–ö–∞—Å—Å–∏—Ä: –í–∞—Å–∏–ª—å–∫–æ–≤–∞ –û.–ù.\n–î–∞—Ç–∞: ${now}\n`;
    txt += "‚Äî" .repeat(25) + "\n";
    cart.forEach(i => txt += `${i.name}\n       ${i.price} ‚ÇΩ\n`);
    txt += "‚Äî" .repeat(25) + "\n";
    txt += `–ò—Ç–æ–≥–æ: ${sum + bonus} ‚ÇΩ\n`;
    if (bonus) txt += `–ë–æ–Ω—É—Å—ã: -${bonus} ‚ÇΩ\n`;
    txt += `–ö –æ–ø–ª–∞—Ç–µ: ${sum} ‚ÇΩ\n–û–ø–ª–∞—Ç–∞: ${method}\n`;
    if (change) txt += `–°–¥–∞—á–∞: ${change} ‚ÇΩ\n`;
    txt += "‚Äî" .repeat(25) + "\n–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!";
    document.getElementById("receipt-content").textContent = txt;
    document.getElementById("payment-screen").style.display = "none";
    document.getElementById("receipt-screen").style.display = "flex";
  }

  function savePurchase(sum, bonus, method) {
    db.ref('purchases').push({
      timestamp: firebase.database.ServerValue.TIMESTAMP,
      items: cart,
      total: sum + bonus,
      paid: sum,
      bonusUsed: bonus,
      method,
      cashier: "–í–∞—Å–∏–ª—å–∫–æ–≤–∞ –û.–ù."
    });
  }

  function printReceipt() { window.print(); }
  function backToCashier() {
    document.getElementById("receipt-screen").style.display = "none";
    showCashier();
  }
  function resetCart() { cart = []; updateCart(); }
  function resetSession() { if (confirm("–°–±—Ä–æ—Å–∏—Ç—å —Å–º–µ–Ω—É?")) resetCart(); }

  document.addEventListener('keydown', e => {
    if (e.key === 'F2') {
      e.preventDefault();
      showCatalog();
    }
  });

  document.getElementById("login-screen").style.display = "flex";
</script>

</body>
</html>
