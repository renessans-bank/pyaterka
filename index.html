<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞—Å—Å–∞ –ü—è—Ç—ë—Ä–∫–∞</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 15px; max-width: 800px; margin: 0 auto; background: #f9f9f9; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    button {
      width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 6px;
      background: #3498db; color: white; font-size: 15px; cursor: pointer;
    }
    .btn-secondary { background: #95a5a6; }
    .btn-success { background: #2ecc71; }
    .btn-danger { background: #e74c3c; }
    .btn-archive { background: #9b59b6; }
    button:hover { opacity: 0.9; }
    input, select {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px;
    }
    .hidden { display: none; }
    .receipt, .archive-item, .message {
      background: white; padding: 12px; margin: 10px 0; border-radius: 6px;
    }
    .message.success { border-left: 4px solid #2ecc71; color: #27ae60; }
    .message.error { border-left: 4px solid #e74c3c; color: #c0392b; }
    .scan-layout { display: flex; gap: 15px; }
    .scan-main { flex: 2; }
    .scan-sidebar { flex: 1; background: #ecf0f1; padding: 15px; border-radius: 8px; }
    #hidden-input { position: absolute; left: -9999px; opacity: 0; }
    #cart-items { min-height: 120px; background: white; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .instructions { text-align: center; color: #7f8c8d; font-size: 13px; margin-top: 10px; }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="screen-login">
  <h2>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
  <form id="loginForm">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" />
    <button type="submit">–í–æ–π—Ç–∏</button>
  </form>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
<div id="screen-main" class="hidden">
  <h2>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
  <div class="scan-layout">
    <div class="scan-main">
      <p><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</strong></p>
      <input type="text" id="hidden-input" autocomplete="off" autofocus />
      <div id="cart-items">
        <h3>–¢–æ–≤–∞—Ä—ã –≤ —á–µ–∫–µ:</h3>
        <p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
      </div>
      <div id="message-area"></div>
      <button id="btn-cancel-last" class="btn-danger">üóëÔ∏è –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä</button>
      <button id="btn-cancel-all" class="btn-secondary">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å—é –ø–æ–∫—É–ø–∫—É</button>
      <button id="btn-pay">üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
      <button id="btn-generate-barcode" class="btn-archive">üè∑Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥</button>
      <p class="instructions">–ù–∞–∂–º–∏—Ç–µ F2 –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞—Ä—Ö–∏–≤–∞ –ø–æ–∫—É–ø–æ–∫</p>
    </div>
    <div class="scan-sidebar">
      <h3>–†—É—á–Ω–æ–π –≤–≤–æ–¥</h3>
      <input type="text" id="manual-barcode" placeholder="–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥" />
      <button id="btn-add-manual">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>

      <h3>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h3>
      <input type="tel" id="loyalty-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
      <button id="btn-new-client">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</button>
      <button id="btn-apply-loyalty">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
    </div>
  </div>
</div>

<!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ -->
<div id="screen-new-client" class="hidden">
  <h2>–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h2>
  <input type="text" id="new-fio" placeholder="–§–ò–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
  <input type="tel" id="new-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
  <input type="number" id="new-birth-year" placeholder="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä. 1990)" min="1900" max="2025" />
  <button id="btn-save-client">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  <button id="btn-back-client">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Å—Å–µ</button>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
<div id="screen-generate" class="hidden">
  <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>
  <div id="product-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
  <div id="generated-barcode" class="hidden">
    <svg id="barcode-svg" style="width:100%; height:100px;"></svg>
    <p id="barcode-text" style="text-align:center; font-size:16px;"></p>
  </div>
  <button id="btn-back-generate">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –û–ø–ª–∞—Ç–∞ -->
<div id="screen-payment" class="hidden">
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
  <div id="cart-summary"></div>
  <button id="btn-pay-cash">üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏</button>
  <button id="btn-pay-card">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π</button>
  <button id="btn-back-payment">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º</button>
</div>

<!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
<div id="screen-cash" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏</h2>
  <input type="number" id="cash-given" placeholder="–°–∫–æ–ª—å–∫–æ –¥–∞–ª –ø–æ–∫—É–ø–∞—Ç–µ–ª—å?" step="0.01" />
  <p id="change-info"></p>
  <button id="btn-complete-cash">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
  <button id="btn-back-cash">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ö–∞—Ä—Ç–∞ -->
<div id="screen-card" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</h2>
  <p>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: <span id="card-total">0.00</span> ‚ÇΩ</p>
  <p style="color:#e74c3c; font-weight:bold;">–ö–∞—Å—Å–∏—Ä, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É</p>
  <button id="btn-confirm-card" class="btn-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
  <button id="btn-back-card">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫ -->
<div id="screen-archive" class="hidden">
  <h2>–ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫</h2>
  <button id="btn-back-archive">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Å—Å–µ</button>
  <div id="archive-list" style="margin-top: 15px;"></div>
</div>

<!-- –ß–µ–∫ -->
<div id="screen-receipt" class="hidden">
  <div class="receipt" id="receipt-content"></div>
  <button id="btn-print">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —á–µ–∫</button>
  <button id="btn-new-sale">‚ûï –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</button>
</div>

<script>
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// ~~~~~~~~~~~~~~~~~~~~~ –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ~~~~~~~~~~~~~~~~
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const ACCESS_PASSWORD = '0506';
const CASHIER_NAME = '–§—Ä–æ–ª–æ–≤ –Æ—Ä–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á';
const INN = '0109764890';
const DATABASE_URL = 'https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/';

// ~~~~~~~~~~~~~~~~~~~~~ –ë–ê–ó–ê –¢–û–í–ê–†–û–í (100+) ~~~~~~~~~~~~~~~~~~~
const PRODUCTS = [
  {name:"–ü–∞–∫–µ—Ç",price:3.00},{name:"–ú–æ–ª–æ–∫–æ 1–ª",price:119.90},{name:"–•–ª–µ–± –±–µ–ª—ã–π",price:64.50},
  {name:"–Ø–π—Ü–∞ 10 —à—Ç",price:149.00},{name:"–°—ã—Ä 200–≥",price:249.90},{name:"–ö–æ–ª–∞ 0.5–ª",price:89.00},
  {name:"–®–æ–∫–æ–ª–∞–¥",price:95.50},{name:"–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ",price:189.00},{name:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å 1–∫–≥",price:45.00},
  {name:"–°–∞—Ö–∞—Ä 1–∫–≥",price:79.90},{name:"–ß–∞–π —á–µ—Ä–Ω—ã–π",price:210.00},{name:"–†–∏—Å 1–∫–≥",price:120.00},
  {name:"–ö–æ—Ñ–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π",price:350.00},{name:"–ü–µ—á–µ–Ω—å–µ",price:85.00},{name:"–°–æ–∫ 1–ª",price:130.00},
  {name:"–ú–∞–∫–∞—Ä–æ–Ω—ã",price:65.00},{name:"–ö–µ—Ç—á—É–ø",price:110.00},{name:"–ú–∞–π–æ–Ω–µ–∑",price:125.00},
  {name:"–°–∞–ª—Ñ–µ—Ç–∫–∏",price:40.00},{name:"–ó—É–±–Ω–∞—è –ø–∞—Å—Ç–∞",price:160.00},{name:"–®–∞–º–ø—É–Ω—å",price:290.00}
];
while (PRODUCTS.length < 100) {
  PRODUCTS.push({ 
    name: `–¢–æ–≤–∞—Ä ${PRODUCTS.length + 1}`, 
    price: parseFloat((50 + Math.random() * 950).toFixed(2)) 
  });
}

// ~~~~~~~~~~~~~~~~~~~~~ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ~~~~~~~~~~~~~~~
const firebaseConfig = { databaseURL: DATABASE_URL };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ~~~~~~~~~~~~~~~~~~~~~ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ~~~~~~~~~~~~~~~~
let cart = [];
let loyaltyPhone = '';

// ~~~~~~~~~~~~~~~~~~~~~ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ~~~~~~~~~~~~~~~
function generateEAN13() {
  const prefix = '200';
  const random = Math.floor(Math.random() * 1e9).toString().padStart(9, '0');
  const base = prefix + random;
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    const digit = parseInt(base[i], 10);
    sum += digit * (i % 2 === 0 ? 1 : 3);
  }
  const checkDigit = (10 - (sum % 10)) % 10;
  return base + checkDigit;
}

function showScreen(screenId) {
  document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(screenId).classList.remove('hidden');
}

function showMessage(text, type = 'success') {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type}`;
  messageDiv.textContent = text;
  const area = document.getElementById('message-area');
  area.innerHTML = '';
  area.appendChild(messageDiv);
  setTimeout(() => { if (messageDiv.parentNode) messageDiv.remove(); }, 3000);
}

function renderCart() {
  const container = document.getElementById('cart-items');
  container.innerHTML = '<h3>–¢–æ–≤–∞—Ä—ã –≤ —á–µ–∫–µ:</h3>';
  if (cart.length === 0) {
    container.innerHTML += '<p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>';
    return;
  }
  let total = 0;
  cart.forEach((item, index) => {
    total += item.price;
    const itemDiv = document.createElement('div');
    itemDiv.textContent = `${index + 1}. ${item.name} ‚Äî ${item.price.toFixed(2)} ‚ÇΩ`;
    container.appendChild(itemDiv);
  });
  const totalDiv = document.createElement('div');
  totalDiv.innerHTML = `<hr><p><strong>–ò—Ç–æ–≥–æ: ${total.toFixed(2)} ‚ÇΩ</strong></p>`;
  container.appendChild(totalDiv);
}

// ~~~~~~~~~~~~~~~~~~~~~ –†–ê–ë–û–¢–ê –° FIREBASE ~~~~~~~~~~~~~~~~~~~~
async function addProductToDB(product, barcode) {
  await db.ref('products/' + barcode).set({
    name: product.name,
    price: product.price,
    used: false
  });
}

async function getProductByBarcode(barcode) {
  const snapshot = await db.ref('products/' + barcode).once('value');
  return snapshot.exists() ? { barcode, ...snapshot.val() } : null;
}

async function markAsUsed(barcode) {
  await db.ref('products/' + barcode).update({ used: true });
}

async function saveReceipt(receiptData) {
  await db.ref('receipts').push(receiptData);
}

async function saveLoyaltyClient(fio, phone, birthYear) {
  const cleanPhone = phone.replace(/\D/g, '');
  await db.ref('loyalty/' + cleanPhone).set({
    fio: fio,
    phone: phone,
    birthYear: birthYear,
    bonus: 0,
    createdAt: Date.now()
  });
}

async function loadReceipts() {
  const snapshot = await db.ref('receipts').once('value');
  return snapshot.val() ? Object.values(snapshot.val()) : [];
}

// ~~~~~~~~~~~~~~~~~~~~~ –û–ë–†–ê–ë–û–¢–ö–ê –®–¢–†–ò–•–ö–û–î–ê ~~~~~~~~~~~~~~~~~~
async function processBarcode(inputValue) {
  let cleanCode = inputValue.replace(/\D/g, '');
  if (cleanCode.length > 13) cleanCode = cleanCode.slice(-13);
  if (cleanCode.length !== 13) {
    showMessage('–®—Ç—Ä–∏—Ö–∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 13 —Ü–∏—Ñ—Ä', 'error');
    return;
  }

  const product = await getProductByBarcode(cleanCode);
  if (!product) {
    showMessage('‚ùå –®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
    return;
  }
  if (product.used) {
    showMessage('–≠—Ç–æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω', 'error');
    return;
  }

  await markAsUsed(cleanCode);
  cart.push({ ...product, quantity: 1 });
  renderCart();
  showMessage('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–µ–∫', 'success');
}

// ~~~~~~~~~~~~~~~~~~~~~ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ~~~~~~~~~~~~~~~~~~
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (document.getElementById('password').value === ACCESS_PASSWORD) {
    showScreen('screen-main');
    setTimeout(() => document.getElementById('hidden-input').focus(), 100);
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }
});

document.getElementById('hidden-input').addEventListener('keydown', async function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const value = e.target.value.trim();
    e.target.value = '';
    if (value) await processBarcode(value);
  }
});

document.getElementById('btn-add-manual').addEventListener('click', async function() {
  const value = document.getElementById('manual-barcode').value.trim();
  if (value) {
    document.getElementById('manual-barcode').value = '';
    await processBarcode(value);
  } else {
    showMessage('–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥', 'error');
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –õ–û–Ø–õ–¨–ù–û–°–¢–¨ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-new-client').addEventListener('click', function() {
  showScreen('screen-new-client');
});

document.getElementById('btn-back-client').addEventListener('click', function() {
  showScreen('screen-main');
});

document.getElementById('btn-save-client').addEventListener('click', async function() {
  const fio = document.getElementById('new-fio').value.trim();
  const phone = document.getElementById('new-phone').value.trim();
  const birthYear = document.getElementById('new-birth-year').value;
  if (!fio || !phone || !birthYear) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.');
    return;
  }
  if (isNaN(birthYear) || birthYear < 1900 || birthYear > 2025) {
    alert('–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1900 –¥–æ 2025.');
    return;
  }
  await saveLoyaltyClient(fio, phone, birthYear);
  document.getElementById('loyalty-phone').value = phone;
  alert('–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
  showScreen('screen-main');
});

document.getElementById('btn-apply-loyalty').addEventListener('click', function() {
  loyaltyPhone = document.getElementById('loyalty-phone').value.trim() || '';
  if (loyaltyPhone) {
    showMessage('–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
  } else {
    showMessage('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω', 'error');
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–†–ó–ò–ù–û–ô ~~~~~~~~~~~~~~~~~~
document.getElementById('btn-cancel-last').addEventListener('click', function() {
  if (cart.length === 0) {
    showMessage('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã', 'error');
    return;
  }
  cart.pop();
  renderCart();
  showMessage('–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω', 'success');
});

document.getElementById('btn-cancel-all').addEventListener('click', function() {
  if (cart.length === 0) {
    showMessage('–ö–æ—Ä–∑–∏–Ω–∞ —É–∂–µ –ø—É—Å—Ç–∞', 'error');
    return;
  }
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Å—é –ø–æ–∫—É–ø–∫—É?')) {
    cart = [];
    renderCart();
    showMessage('–ü–æ–∫—É–ø–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –ì–ï–ù–ï–†–ê–¶–ò–Ø –®–¢–†–ò–•–ö–û–î–ê ~~~~~~~~~~~~~~~~~~
document.getElementById('btn-generate-barcode').addEventListener('click', function() {
  const list = document.getElementById('product-list');
  list.innerHTML = '';
  PRODUCTS.forEach(product => {
    const btn = document.createElement('button');
    btn.textContent = `${product.name} ‚Äî ${product.price.toFixed(2)} ‚ÇΩ`;
    btn.onclick = async function() {
      const barcode = generateEAN13();
      await addProductToDB(product, barcode);
      JsBarcode("#barcode-svg", barcode, {
        format: "EAN13",
        lineColor: "#000",
        height: 80,
        displayValue: true
      });
      document.getElementById('barcode-text').textContent = barcode;
      document.getElementById('generated-barcode').classList.remove('hidden');
    };
    list.appendChild(btn);
  });
  showScreen('screen-generate');
});

document.getElementById('btn-back-generate').addEventListener('click', function() {
  showScreen('screen-main');
});

// ~~~~~~~~~~~~~~~~~~~~~ –û–ü–õ–ê–¢–ê ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-pay').addEventListener('click', function() {
  if (cart.length === 0) {
    showMessage('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä', 'error');
    return;
  }
  let total = 0;
  cart.forEach(item => total += item.price);
  document.getElementById('cart-summary').innerHTML = `<h3>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: ${total.toFixed(2)} ‚ÇΩ</h3>`;
  document.getElementById('card-total').textContent = total.toFixed(2);
  showScreen('screen-payment');
});

document.getElementById('btn-back-payment').addEventListener('click', function() {
  showScreen('screen-main');
});

document.getElementById('btn-pay-cash').addEventListener('click', function() {
  showScreen('screen-cash');
});

document.getElementById('btn-pay-card').addEventListener('click', function() {
  showScreen('screen-card');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ù–ê–õ–ò–ß–ù–´–ï –ò –ö–ê–†–¢–ê ~~~~~~~~~~~~~~~~~~~~~
document.getElementById('cash-given').addEventListener('input', function() {
  const cashInput = parseFloat(document.getElementById('cash-given').value);
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const info = document.getElementById('change-info');
  if (!isNaN(cashInput) && cashInput >= total) {
    const change = (cashInput - total).toFixed(2);
    info.textContent = `–°–¥–∞—á–∞: ${change} ‚ÇΩ`;
    info.style.color = '#27ae60';
  } else {
    info.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!';
    info.style.color = '#e74c3c';
  }
});

document.getElementById('btn-complete-cash').addEventListener('click', async function() {
  const cashInput = parseFloat(document.getElementById('cash-given').value);
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  if (isNaN(cashInput) || cashInput < total) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –æ–ø–ª–∞—Ç—ã!');
    return;
  }
  await finalizeSale('cash', cashInput);
});

document.getElementById('btn-confirm-card').addEventListener('click', async function() {
  await finalizeSale('card');
});

document.getElementById('btn-back-cash').addEventListener('click', function() {
  showScreen('screen-payment');
});

document.getElementById('btn-back-card').addEventListener('click', function() {
  showScreen('screen-payment');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ó–ê–í–ï–†–®–ï–ù–ò–ï –ü–†–û–î–ê–ñ–ò ~~~~~~~~~~~~~~~~~~~
async function finalizeSale(paymentMethod, cashGiven = null) {
  const total = cart.reduce((sum, item) => sum + item.price, 0);
  const receiptData = {
    items: cart,
    total: total,
    paymentMethod: paymentMethod,
    cashGiven: cashGiven,
    change: cashGiven ? parseFloat((cashGiven - total).toFixed(2)) : null,
    loyaltyPhone: loyaltyPhone,
    cashier: CASHIER_NAME,
    inn: INN,
    timestamp: Date.now()
  };
  await saveReceipt(receiptData);
  renderReceipt(receiptData);
  showScreen('screen-receipt');
}

function renderReceipt(receipt) {
  let html = `<h2 style="text-align:center;">–ö–ê–°–°–û–í–´–ô –ß–ï–ö</h2>`;
  html += `<p><strong>–ò–ù–ù:</strong> ${receipt.inn}</p>`;
  html += `<p><strong>–ö–∞—Å—Å–∏—Ä:</strong> ${receipt.cashier}</p><hr>`;
  receipt.items.forEach(item => {
    html += `<p>${item.name} ‚Äî ${item.price.toFixed(2)} ‚ÇΩ</p>`;
  });
  html += `<hr><p><strong>–ò–¢–û–ì–û:</strong> ${receipt.total.toFixed(2)} ‚ÇΩ</p>`;
  if (receipt.paymentMethod === 'cash') {
    html += `<p><strong>–ù–∞–ª–∏—á–Ω—ã–º–∏:</strong> ${receipt.cashGiven.toFixed(2)} ‚ÇΩ</p>`;
    html += `<p><strong>–°–¥–∞—á–∞:</strong> ${receipt.change.toFixed(2)} ‚ÇΩ</p>`;
  } else {
    html += `<p><strong>–û–ø–ª–∞—Ç–∞:</strong> –ë–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π</p>`;
  }
  html += `<p><strong>–î–∞—Ç–∞:</strong> ${new Date(receipt.timestamp).toLocaleString('ru-RU')}</p>`;
  document.getElementById('receipt-content').innerHTML = html;
}

// ~~~~~~~~~~~~~~~~~~~~~ –ê–†–•–ò–í –ü–û–ö–£–ü–û–ö ~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-back-archive').addEventListener('click', function() {
  showScreen('screen-main');
});

document.addEventListener('keydown', async function(e) {
  if (e.key === 'F2') {
    e.preventDefault();
    const receipts = await loadReceipts();
    const list = document.getElementById('archive-list');
    list.innerHTML = '<h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>';
    if (receipts.length === 0) {
      list.innerHTML += '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –∞—Ä—Ö–∏–≤–µ</p>';
    } else {
      receipts.reverse().forEach(r => {
        const div = document.createElement('div');
        div.className = 'archive-item';
        div.innerHTML = `
          <p><strong>${new Date(r.timestamp).toLocaleString('ru-RU')}</strong></p>
          <p>–°—É–º–º–∞: ${r.total.toFixed(2)} ‚ÇΩ</p>
          <p>–û–ø–ª–∞—Ç–∞: ${r.paymentMethod === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : '–ö–∞—Ä—Ç–∞'}</p>
        `;
        list.appendChild(div);
      });
    }
    showScreen('screen-archive');
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –ß–ï–ö –ò –ù–û–í–ê–Ø –ü–†–û–î–ê–ñ–ê ~~~~~~~~~~~~~~~~~~
document.getElementById('btn-print').addEventListener('click', function() {
  window.print();
});

document.getElementById('btn-new-sale').addEventListener('click', function() {
  cart = [];
  loyaltyPhone = '';
  document.getElementById('loyalty-phone').value = '';
  document.getElementById('cash-given').value = '';
  showScreen('screen-main');
  renderCart();
});

// ~~~~~~~~~~~~~~~~~~~~~ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ~~~~~~~~~~~~~~~~~~~~~~~~
renderCart();
showScreen('screen-login');
console.log("–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–µ—Ä—Å–∏—è 1.0. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã.");
</script>
</body>
</html>
