<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞—Å—Å–∞ –ü—è—Ç—ë—Ä–∫–∞</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 15px; max-width: 600px; margin: 0 auto; background: #f9f9f9; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    button {
      width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 6px;
      background: #3498db; color: white; font-size: 15px; cursor: pointer;
    }
    .btn-secondary { background: #95a5a6; }
    .btn-success { background: #2ecc71; }
    .btn-danger { background: #e74c3c; }
    button:hover { opacity: 0.9; }
    input, select {
      width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 4px;
    }
    .hidden { display: none; }
    .receipt, .archive-item, .barcode-print-area {
      background: white; padding: 15px; margin: 15px 0; border-radius: 8px;
    }
    video { width: 100%; height: auto; background: black; margin: 10px 0; }
    #barcode-svg { width: 100%; height: auto; margin: 15px 0; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    @media print {
      body * { display: none; }
      .barcode-print-area, .barcode-print-area * { display: block !important; }
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="screen-login">
  <h2>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h2>
  <form id="loginForm">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" />
    <button type="submit">–í–æ–π—Ç–∏</button>
  </form>
</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="screen-dashboard" class="hidden">
  <h1>–ö–∞—Å—Å–∞ ¬´–ü—è—Ç—ë—Ä–∫–∞¬ª</h1>
  <button id="btn-generate">üè∑Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥</button>
  <button id="btn-scan">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã</button>
  <button id="btn-checkout" class="hidden">üí∞ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ (<span id="cart-count">0</span>)</button>
  <button id="btn-archive">üìÇ –ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫</button>
  <button id="btn-logout">üîê –í—ã–π—Ç–∏</button>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
<div id="screen-generate" class="hidden">
  <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>
  <button id="back-from-generate">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="product-list" style="max-height: 400px; overflow-y: auto;"></div>
  <div id="generated-barcode" class="hidden">
    <h3>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:</h3>
    <svg id="barcode-svg"></svg>
    <p id="barcode-text"></p>
    <button id="btn-print-barcode">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥</button>
  </div>
</div>

<!-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
<div id="screen-scan" class="hidden">
  <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–¥—Ä—è–¥)</h2>
  <button id="finish-scanning" class="btn-danger">‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
  <button id="start-scan">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
  <video id="video" playsinline></video>
  <p id="scan-result"></p>
  <div id="scanned-items"></div>
</div>

<!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
<div id="screen-loyalty" class="hidden">
  <h2>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h2>
  <button id="btn-has-card">‚úÖ –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–∞—Ä—Ç–∞</button>
  <button id="btn-no-card">üÜï –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É</button>
  <button id="btn-skip-loyalty" class="btn-secondary">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
</div>

<!-- –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
<div id="screen-enter-phone" class="hidden">
  <h2>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h2>
  <input type="tel" id="phone-input" placeholder="+7 (999) 123-45-67" />
  <button id="btn-continue-with-phone">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  <button id="back-from-phone">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="screen-register-card" class="hidden">
  <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã</h2>
  <input type="text" id="reg-fio" placeholder="–§–ò–û" />
  <input type="tel" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
  <label>–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–∏–º—ã–π –ø—Ä–æ–¥—É–∫—Ç (5% –±–æ–Ω—É—Å–æ–≤):</label>
  <select id="fav-product-single" style="height: 200px;"></select>
  <button id="btn-register-card">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="back-from-register">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –û–ø–ª–∞—Ç–∞ -->
<div id="screen-checkout" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞</h2>
  <div id="cart-items"></div>
  <h3>–ò—Ç–æ–≥–æ: <span id="total">0.00</span> ‚ÇΩ</h3>
  <div id="bonus-info" class="hidden">
    <p>–í–∞—à–∏ –±–æ–Ω—É—Å—ã: <span id="user-bonus">0</span> ‚ÇΩ</p>
    <input type="number" id="use-bonus" placeholder="–°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã (1 –±–æ–Ω—É—Å = 1 ‚ÇΩ)" min="0" />
  </div>
  <button id="btn-pay-cash">üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏</button>
  <button id="btn-pay-card">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π</button>
  <button id="back-from-payment">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
<div id="screen-cash" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏</h2>
  <input type="number" id="cash-given" placeholder="–°–∫–æ–ª—å–∫–æ –¥–∞–ª –ø–æ–∫—É–ø–∞—Ç–µ–ª—å?" step="0.01" />
  <p id="change-info"></p>
  <button id="btn-complete-cash">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
  <button id="back-from-cash">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ö–∞—Ä—Ç–∞ -->
<div id="screen-card" class="hidden">
  <h2>–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</h2>
  <p>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: <span id="card-total">0.00</span> ‚ÇΩ</p>
  <p style="color: #e74c3c;">–ö–∞—Å—Å–∏—Ä, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É</p>
  <button id="btn-confirm-card" class="btn-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
  <button id="back-from-card">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ê—Ä—Ö–∏–≤ -->
<div id="screen-archive" class="hidden">
  <h2>–ê—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫</h2>
  <button id="back-from-archive">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="archive-list"></div>
</div>

<!-- –ß–µ–∫ -->
<div id="screen-receipt" class="hidden">
  <div class="receipt" id="receipt-content"></div>
  <button id="btn-print">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —á–µ–∫</button>
  <button id="btn-new-sale">‚ûï –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</button>
</div>

<!-- –°–∫—Ä—ã—Ç–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—á–∞—Ç–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
<div id="print-area" class="hidden">
  <div class="barcode-print-area">
    <h3 style="text-align:center">–®—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞</h3>
    <svg id="print-barcode-svg" style="width:100%; height:auto;"></svg>
    <p id="print-barcode-text" style="text-align:center; font-size:18px; margin-top:10px;"></p>
  </div>
</div>

<script>
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// ~~~~~~~~~~~~~~~~~~~~~ –ö–û–ù–°–¢–ê–ù–¢–´ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const ACCESS_PASSWORD = '0506';
const CASHIER_NAME = '–§—Ä–æ–ª–æ–≤ –Æ—Ä–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á';
const INN = '0109764890';
const DATABASE_URL = 'https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/';
const BONUS_RATE_REGULAR = 0.02;
const BONUS_RATE_FAVORITE = 0.05;

// ~~~~~~~~~~~~~~~~~~~~~ –¢–û–í–ê–†–´ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const PRODUCTS_1000 = [
{name:"–ú–æ–ª–æ–∫–æ 1–ª",price:119.90},{name:"–•–ª–µ–± –±–µ–ª—ã–π",price:64.50},{name:"–Ø–π—Ü–∞ 10 —à—Ç",price:149.00},
{name:"–°—ã—Ä 200–≥",price:249.90},{name:"–ö–æ–ª–∞ 0.5–ª",price:89.00},{name:"–®–æ–∫–æ–ª–∞–¥",price:95.50},
{name:"–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ",price:189.00},{name:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å 1–∫–≥",price:45.00},{name:"–°–∞—Ö–∞—Ä 1–∫–≥",price:79.90},
{name:"–ß–∞–π —á–µ—Ä–Ω—ã–π",price:210.00},{name:"–†–∏—Å 1–∫–≥",price:120.00},{name:"–ö–æ—Ñ–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π",price:350.00}
];
for (let i = 0; i < 988; i++) {
  PRODUCTS_1000.push({ name: `–¢–æ–≤–∞—Ä ${i + 13}`, price: parseFloat((50 + Math.random() * 950).toFixed(2)) });
}

// ~~~~~~~~~~~~~~~~~~~~~ FIREBASE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
const firebaseConfig = { databaseURL: DATABASE_URL };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ~~~~~~~~~~~~~~~~~~~~~ –ì–õ–û–ë–ê–õ–¨–ù–´–ï ~~~~~~~~~~~~~~~~~~~~~~~~~~~
let cart = [];
let currentStream = null;
let currentBarcode = '';
let loyaltyUser = null;

// ~~~~~~~~~~~~~~~~~~~~~ –ì–ï–ù–ï–†–ê–¶–ò–Ø EAN-13 ~~~~~~~~~~~~~~~~~~~~~
function generateEAN13() {
  const prefix = '200';
  const random = Math.floor(Math.random() * 1e9).toString().padStart(9, '0');
  const base = prefix + random;
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    const d = parseInt(base[i], 10);
    sum += d * (i % 2 === 0 ? 1 : 3);
  }
  const check = (10 - (sum % 10)) % 10;
  return base + check;
}

// ~~~~~~~~~~~~~~~~~~~~~ –®–¢–†–ò–•–ö–û–î + –ü–ï–ß–ê–¢–¨ ~~~~~~~~~~~~~~~~~~~~
function drawRealBarcode(barcode, target = 'barcode-svg') {
  document.getElementById(target).innerHTML = '';
  try {
    JsBarcode(`#${target}`, barcode, {
      format: "EAN13",
      lineColor: "#000",
      height: 100,
      displayValue: true,
      fontSize: 18,
      textAlign: "center",
      textPosition: "bottom",
      background: "#fff",
      margin: 10
    });
  } catch (e) {
    console.error("JsBarcode error:", e);
  }
}

function printBarcode(barcode, text) {
  drawRealBarcode(barcode, 'print-barcode-svg');
  document.getElementById('print-barcode-text').textContent = text;
  const printContent = document.getElementById('print-area').innerHTML;
  const original = document.body.innerHTML;
  document.body.innerHTML = printContent;
  window.print();
  document.body.innerHTML = original;
  showScreen('screen-generate');
}

// ~~~~~~~~~~~~~~~~~~~~~ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ~~~~~~~~~~~~~~~~~~~~~~~
function calculateChange(cash, total) {
  return parseFloat((cash - total).toFixed(2));
}

function showScreen(id) {
  document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function updateCartUI() {
  document.getElementById('cart-count').textContent = cart.length;
  document.getElementById('btn-checkout').classList.toggle('hidden', cart.length === 0);
}

function renderCart(containerId = 'cart-items') {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.quantity;
    const div = document.createElement('div');
    div.innerHTML = `<strong>${item.name}</strong> ‚Äî ${item.price} ‚ÇΩ`;
    container.appendChild(div);
  });
  document.getElementById('total').textContent = total.toFixed(2);
  if (document.getElementById('card-total')) {
    document.getElementById('card-total').textContent = total.toFixed(2);
  }
}

// ~~~~~~~~~~~~~~~~~~~~~ FIREBASE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
async function addProductToDB(product, barcode) {
  await db.ref('products/' + barcode).set({ name: product.name, price: product.price, used: false });
}

async function getProductByBarcode(barcode) {
  const snap = await db.ref('products/' + barcode).once('value');
  return snap.exists() ? { barcode, ...snap.val() } : null;
}

async function markAsUsed(barcode) {
  await db.ref('products/' + barcode).update({ used: true });
}

async function saveReceipt(receipt) {
  await db.ref('receipts').push(receipt);
}

async function getReceipts() {
  const snap = await db.ref('receipts').once('value');
  return snap.val() ? Object.values(snap.val()) : [];
}

async function getOrCreateLoyaltyUser(phone, fio = null, fav = null) {
  const cleanPhone = phone.replace(/\D/g, '');
  const userRef = db.ref('loyalty/' + cleanPhone);
  const snap = await userRef.once('value');
  if (snap.exists()) {
    return { phone: cleanPhone, ...snap.val() };
  } else {
    const newUser = { phone: cleanPhone, fio, fav, bonus: 0 };
    await userRef.set(newUser);
    return newUser;
  }
}

async function addBonus(phone, amount) {
  const cleanPhone = phone.replace(/\D/g, '');
  const userRef = db.ref('loyalty/' + cleanPhone);
  const snap = await userRef.once('value');
  if (snap.exists()) {
    const current = snap.val().bonus || 0;
    await userRef.update({ bonus: current + amount });
  }
}

async function useBonus(phone, amount) {
  const cleanPhone = phone.replace(/\D/g, '');
  const userRef = db.ref('loyalty/' + cleanPhone);
  const snap = await userRef.once('value');
  if (snap.exists()) {
    const current = snap.val().bonus || 0;
    if (current >= amount) {
      await userRef.update({ bonus: current - amount });
      return true;
    }
  }
  return false;
}

// ~~~~~~~~~~~~~~~~~~~~~ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–Æ–ë–ò–ú–û–ì–û ~~~~~~~~~~~~~~~
function initFavoriteProductSelect() {
  const sel = document.getElementById('fav-product-single');
  sel.innerHTML = '';
  PRODUCTS_1000.slice(0, 50).forEach((p, i) => {
    const opt = document.createElement('option');
    opt.value = p.name;
    opt.textContent = `${p.name} ‚Äî ${p.price} ‚ÇΩ`;
    sel.appendChild(opt);
  });
}

// ~~~~~~~~~~~~~~~~~~~~~ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (document.getElementById('password').value === ACCESS_PASSWORD) {
    localStorage.setItem('auth', 'true');
    showScreen('screen-dashboard');
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
  }
});

document.getElementById('btn-logout').addEventListener('click', () => {
  localStorage.removeItem('auth');
  showScreen('screen-login');
  cart = []; loyaltyUser = null;
  updateCartUI();
});

// ~~~~~~~~~~~~~~~~~~~~~ –ì–ï–ù–ï–†–ê–¶–ò–Ø ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-generate').addEventListener('click', () => {
  const list = document.getElementById('product-list');
  list.innerHTML = '';
  PRODUCTS_1000.slice(0, 30).forEach(p => {
    const btn = document.createElement('button');
    btn.textContent = `${p.name} ‚Äî ${p.price} ‚ÇΩ`;
    btn.onclick = async () => {
      const barcode = generateEAN13();
      console.log("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Firebase:", barcode);
      try {
        drawRealBarcode(barcode);
        await addProductToDB(p, barcode);
        document.getElementById('barcode-text').textContent = barcode;
        document.getElementById('generated-barcode').classList.remove('hidden');
        currentBarcode = barcode;
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
      }
    };
    list.appendChild(btn);
  });
  showScreen('screen-generate');
});

document.getElementById('btn-print-barcode').addEventListener('click', () => {
  const text = document.getElementById('barcode-text').textContent;
  printBarcode(currentBarcode, text);
});

// ~~~~~~~~~~~~~~~~~~~~~ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-scan').addEventListener('click', () => {
  showScreen('screen-scan');
  document.getElementById('scanned-items').innerHTML = '';
});

document.getElementById('finish-scanning').addEventListener('click', () => {
  if (cart.length === 0) {
    alert('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã');
    return;
  }
  showScreen('screen-loyalty');
});

document.getElementById('start-scan').addEventListener('click', async () => {
  const video = document.getElementById('video');
  const res = document.getElementById('scan-result');
  res.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    currentStream = stream;
    video.srcObject = stream;

    const reader = new ZXing.BrowserMultiFormatReader();
    reader.decodeFromVideoDevice(null, 'video', async (result) => {
      if (result) {
        // üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –æ—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
        let raw = result.getText();
        let clean = raw.replace(/\D/g, ''); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        if (clean.length > 13) clean = clean.slice(-13); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 13
        if (clean.length === 13) {
          console.log("–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω:", clean);
          res.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ' + clean;
          const prod = await getProductByBarcode(clean);
          if (!prod) {
            alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —ç—Ç–æ–π –∫–∞—Å—Å–µ.');
          } else if (prod.used) {
            alert('–≠—Ç–æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!');
          } else {
            await markAsUsed(clean);
            cart.push({ ...prod, quantity: 1 });
            updateCartUI();
            const itemsDiv = document.getElementById('scanned-items');
            const div = document.createElement('div');
            div.textContent = `‚úÖ ${prod.name}`;
            itemsDiv.appendChild(div);
          }
        } else {
          res.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞: ' + raw;
          alert('–®—Ç—Ä–∏—Ö–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 13 —Ü–∏—Ñ—Ä. –ü–æ–ª—É—á–µ–Ω–æ: ' + clean.length);
        }
        reader.reset();
        stream.getTracks().forEach(t => t.stop());
      }
    });
  } catch (err) {
    res.textContent = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + err.message;
  }
});

// ~~~~~~~~~~~~~~~~~~~~~ –õ–û–Ø–õ–¨–ù–û–°–¢–¨ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-has-card').addEventListener('click', () => {
  showScreen('screen-enter-phone');
});

document.getElementById('btn-no-card').addEventListener('click', () => {
  initFavoriteProductSelect();
  showScreen('screen-register-card');
});

document.getElementById('btn-skip-loyalty').addEventListener('click', () => {
  loyaltyUser = null;
  showScreen('screen-checkout');
  renderCart();
});

document.getElementById('btn-continue-with-phone').addEventListener('click', async () => {
  const phone = document.getElementById('phone-input').value;
  if (!phone) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
  loyaltyUser = await getOrCreateLoyaltyUser(phone);
  showScreen('screen-checkout');
  renderCart();
  document.getElementById('bonus-info').classList.remove('hidden');
  document.getElementById('user-bonus').textContent = loyaltyUser.bonus;
});

document.getElementById('btn-register-card').addEventListener('click', async () => {
  const fio = document.getElementById('reg-fio').value;
  const phone = document.getElementById('reg-phone').value;
  const fav = document.getElementById('fav-product-single').value;
  if (!fio || !phone || !fav) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  loyaltyUser = await getOrCreateLoyaltyUser(phone, fio, fav);
  showScreen('screen-checkout');
  renderCart();
  document.getElementById('bonus-info').classList.remove('hidden');
  document.getElementById('user-bonus').textContent = loyaltyUser.bonus;
});

['back-from-generate', 'back-from-scan', 'back-from-payment', 'back-from-cash', 'back-from-card', 'back-from-archive', 'back-from-phone', 'back-from-register'].forEach(id => {
  document.getElementById(id).addEventListener('click', () => showScreen('screen-dashboard'));
});

document.getElementById('btn-archive').addEventListener('click', async () => {
  const receipts = await getReceipts();
  const list = document.getElementById('archive-list');
  list.innerHTML = '<h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>';
  if (receipts.length === 0) {
    list.innerHTML += '<p>–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫</p>';
  } else {
    receipts.reverse().forEach(r => {
      const div = document.createElement('div');
      div.className = 'archive-item';
      div.innerHTML = `
        <p><strong>${new Date(r.timestamp).toLocaleString('ru-RU')}</strong></p>
        <p>–°—É–º–º–∞: ${r.total.toFixed(2)} ‚ÇΩ</p>
        ${r.bonusUsed ? `<p>–°–ø–∏—Å–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤: ${r.bonusUsed} ‚ÇΩ</p>` : ''}
        ${r.loyaltyPhone ? `<p>–¢–µ–ª–µ—Ñ–æ–Ω: ${r.loyaltyPhone}</p>` : ''}
      `;
      list.appendChild(div);
    });
  }
  showScreen('screen-archive');
});

// ~~~~~~~~~~~~~~~~~~~~~ –û–ü–õ–ê–¢–ê ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-checkout').addEventListener('click', () => {
  showScreen('screen-loyalty');
});

document.getElementById('btn-pay-cash').addEventListener('click', () => showScreen('screen-cash'));
document.getElementById('btn-pay-card').addEventListener('click', () => showScreen('screen-card'));

document.getElementById('use-bonus').addEventListener('input', () => {
  const total = parseFloat(document.getElementById('total').textContent);
  const bonusInput = document.getElementById('use-bonus');
  let use = parseFloat(bonusInput.value) || 0;
  if (loyaltyUser && use > loyaltyUser.bonus) use = loyaltyUser.bonus;
  if (use > total) use = total;
  bonusInput.value = use;
});

// ~~~~~~~~~~~~~~~~~~~~~ –ù–ê–õ–ò–ß–ù–´–ï ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('cash-given').addEventListener('input', () => {
  const cash = parseFloat(document.getElementById('cash-given').value);
  const total = parseFloat(document.getElementById('total').textContent);
  const bonusUsed = parseFloat(document.getElementById('use-bonus').value) || 0;
  const finalTotal = Math.max(0, total - bonusUsed);
  const info = document.getElementById('change-info');
  if (!isNaN(cash) && cash >= finalTotal) {
    info.textContent = `–°–¥–∞—á–∞: ${calculateChange(cash, finalTotal).toFixed(2)} ‚ÇΩ`;
    info.style.color = 'green';
  } else {
    info.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!';
    info.style.color = 'red';
  }
});

document.getElementById('btn-complete-cash').addEventListener('click', async () => {
  const total = parseFloat(document.getElementById('total').textContent);
  const bonusUsed = parseFloat(document.getElementById('use-bonus').value) || 0;
  const finalTotal = Math.max(0, total - bonusUsed);
  const cash = parseFloat(document.getElementById('cash-given').value);
  if (isNaN(cash) || cash < finalTotal) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');

  if (bonusUsed > 0 && loyaltyUser) {
    const success = await useBonus(loyaltyUser.phone, bonusUsed);
    if (!success) return alert('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤');
  }

  let bonusEarned = 0;
  if (loyaltyUser) {
    cart.forEach(item => {
      const rate = (loyaltyUser.fav && item.name === loyaltyUser.fav) ? BONUS_RATE_FAVORITE : BONUS_RATE_REGULAR;
      bonusEarned += item.price * rate;
    });
    bonusEarned = parseFloat(bonusEarned.toFixed(2));
    await addBonus(loyaltyUser.phone, bonusEarned);
  }

  const receipt = {
    items: cart,
    total,
    finalTotal,
    cashGiven: cash,
    change: calculateChange(cash, finalTotal),
    bonusUsed,
    bonusEarned: bonusEarned || 0,
    loyaltyPhone: loyaltyUser ? loyaltyUser.phone : null,
    cashier: CASHIER_NAME,
    inn: INN,
    timestamp: Date.now()
  };
  await saveReceipt(receipt);
  renderReceipt(receipt);
  showScreen('screen-receipt');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ö–ê–†–¢–ê ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
document.getElementById('btn-confirm-card').addEventListener('click', async () => {
  const total = parseFloat(document.getElementById('total').textContent);
  const bonusUsed = parseFloat(document.getElementById('use-bonus').value) || 0;
  const finalTotal = Math.max(0, total - bonusUsed);

  if (bonusUsed > 0 && loyaltyUser) {
    const success = await useBonus(loyaltyUser.phone, bonusUsed);
    if (!success) return alert('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤');
  }

  let bonusEarned = 0;
  if (loyaltyUser) {
    cart.forEach(item => {
      const rate = (loyaltyUser.fav && item.name === loyaltyUser.fav) ? BONUS_RATE_FAVORITE : BONUS_RATE_REGULAR;
      bonusEarned += item.price * rate;
    });
    bonusEarned = parseFloat(bonusEarned.toFixed(2));
    await addBonus(loyaltyUser.phone, bonusEarned);
  }

  const receipt = {
    items: cart,
    total,
    finalTotal,
    bonusUsed,
    bonusEarned: bonusEarned || 0,
    loyaltyPhone: loyaltyUser ? loyaltyUser.phone : null,
    cashier: CASHIER_NAME,
    inn: INN,
    timestamp: Date.now(),
    paymentMethod: 'card'
  };
  await saveReceipt(receipt);
  renderReceipt(receipt);
  showScreen('screen-receipt');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ß–ï–ö ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function renderReceipt(r) {
  let html = `
    <h2 style="text-align:center">–ö–ê–°–°–û–í–´–ô –ß–ï–ö</h2>
    <p><strong>–ò–ù–ù:</strong> ${r.inn}</p>
    <p><strong>–ö–∞—Å—Å–∏—Ä:</strong> ${r.cashier}</p><hr>
  `;
  r.items.forEach(i => {
    html += `<p>${i.name} x${i.quantity} ‚Äî ${i.price.toFixed(2)} ‚ÇΩ</p>`;
  });
  html += `<hr><p><strong>–ò–¢–û–ì–û:</strong> ${r.total.toFixed(2)} ‚ÇΩ</p>`;
  if (r.bonusUsed > 0) {
    html += `<p><strong>–°–ø–∏—Å–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤:</strong> ${r.bonusUsed.toFixed(2)} ‚ÇΩ</p>`;
    html += `<p><strong>–ö –æ–ø–ª–∞—Ç–µ:</strong> ${r.finalTotal.toFixed(2)} ‚ÇΩ</p>`;
  }
  if (r.cashGiven !== undefined) {
    html += `<p><strong>–ù–∞–ª–∏—á–Ω—ã–º–∏:</strong> ${r.cashGiven.toFixed(2)} ‚ÇΩ</p>`;
    html += `<p><strong>–°–¥–∞—á–∞:</strong> ${r.change.toFixed(2)} ‚ÇΩ</p>`;
  }
  if (r.bonusEarned > 0) {
    html += `<p><strong>+ –ë–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã:</strong> ${r.bonusEarned.toFixed(2)} ‚ÇΩ</p>`;
  }
  html += `<p><strong>–î–∞—Ç–∞:</strong> ${new Date(r.timestamp).toLocaleString('ru-RU')}</p>`;
  document.getElementById('receipt-content').innerHTML = html;
}

document.getElementById('btn-print').addEventListener('click', () => {
  const content = document.getElementById('receipt-content').innerHTML;
  const original = document.body.innerHTML;
  document.body.innerHTML = content;
  window.print();
  document.body.innerHTML = original;
  showScreen('screen-receipt');
});

document.getElementById('btn-new-sale').addEventListener('click', () => {
  cart = []; loyaltyUser = null;
  updateCartUI();
  showScreen('screen-dashboard');
});

// ~~~~~~~~~~~~~~~~~~~~~ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ~~~~~~~~~~~~~~~~~~~~~~~~
window.onload = () => {
  if (localStorage.getItem('auth') === 'true') {
    showScreen('screen-dashboard');
  } else {
    showScreen('screen-login');
  }
  updateCartUI();
};

console.log("–ö–∞—Å—Å–∞ –ü—è—Ç—ë—Ä–∫–∞: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî —Ç–æ–ª—å–∫–æ 13 —Ü–∏—Ñ—Ä, –±–µ–∑ –º—É—Å–æ—Ä–∞.");
</script>
</body>
</html>
